<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Neutryx‑Core — Interactive Pricer Demo</title>
  <style>
    :root{
      --ink:#0a0a0b; --muted:#666; --bg:#f6f7fb; --card:#fff;
      --brand:#0a66c2; --acc:#5b9cff; --ring:rgba(10,102,194,.25);
      --ok:#0ea75a; --warn:#f5b100; --err:#d93025; --border:#e4e6ef;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg)}
    header{position:sticky;top:0;z-index:50;background:#fff;padding:12px 16px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .wrap{max-width:1080px;margin:0 auto;display:flex;align-items:center;gap:14px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
    .brand img{width:36px;height:36px;object-fit:contain}
    .brand span{font-weight:800;letter-spacing:.2px}
    nav{margin-left:auto;display:flex;gap:14px;flex-wrap:wrap}
    nav a{color:var(--brand);text-decoration:none;font-size:.95rem}
    nav a:hover{text-decoration:underline}
    @media (max-width:768px){
      .wrap{flex-direction:column;align-items:flex-start;gap:12px}
      nav{margin-left:0;width:100%;justify-content:flex-start;gap:12px}
      .brand span{font-size:.95rem}
    }
    main{max-width:1080px;margin:0 auto;padding:24px 16px 64px}
    h1{margin:.3rem 0 .6rem;font-size:2rem}
    p{color:#444;line-height:1.7}
    @media (max-width:640px){
      h1{font-size:1.6rem}
      .toolbar{font-size:.9rem}
    }
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);text-decoration:none;color:var(--brand);background:#fff}
    .btn:hover{box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .note,.box{background:#fff;border-left:4px solid var(--brand);padding:12px 14px;border-radius:12px;box-shadow:0 1px 6px rgba(0,0,0,.05)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    @media (max-width:900px){
      .grid > .card{grid-column:span 12!important}
    }
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.04)}
    .card h3{margin:0 0 8px;font-size:1rem}
    .card .section{padding:16px;border-top:1px solid var(--border)}
    .card .section:first-child{border-top:0;border-top-left-radius:16px;border-top-right-radius:16px}
    .card .section:last-child{border-bottom-left-radius:16px;border-bottom-right-radius:16px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:.9rem;color:#333}
    .row{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
    @media (max-width:768px){
      .row{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:480px){
      .row{grid-template-columns:1fr}
    }
    input,select{appearance:none;width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;outline:none}
    input:focus,select:focus{border-color:var(--acc);box-shadow:0 0 0 4px var(--ring)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .primary{background:var(--brand);color:#fff;border-color:transparent}
    .primary:hover{filter:brightness(.98)}
    .ghost{background:#fff;color:var(--ink)}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#eef2ff;border:1px solid #d4dbff;color:#223;display:inline-block;padding:2px 6px;border-radius:6px}
    .status{display:inline-flex;align-items:center;gap:8px;font-size:.9rem}
    .dot{width:9px;height:9px;border-radius:50%}
    .ok{background:var(--ok)} .warn{background:var(--warn)} .err{background:var(--err)} .muted{background:#bbb}
    .mutetext{color:#666}
    pre{margin:0;background:#0b1020;color:#d7e0ff;border-radius:12px;padding:14px;overflow:auto;border:1px solid #0f1630}
    code{font-family:ui-monospace,Consolas,Menlo,monospace;font-size:.92rem}
    .small{font-size:.9rem;color:#555}
    footer{text-align:center;color:#777;padding:28px 16px 44px}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:.8rem;color:#333}
    /* Validation styles */
    .field-error input,.field-error select{border-color:var(--err);background:#fef2f2}
    .error-msg{color:var(--err);font-size:.85rem;margin-top:4px;display:none}
    .field-error .error-msg{display:block}
    /* Loading spinner */
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Copy button */
    .copy-btn{position:absolute;top:10px;right:10px;padding:4px 8px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:#d7e0ff;font-size:.75rem;cursor:pointer;transition:all .2s}
    .copy-btn:hover{background:rgba(255,255,255,.2)}
    .copy-btn.copied{background:var(--ok);color:#fff;border-color:var(--ok)}
    .code-wrapper{position:relative}
    /* Disabled state */
    button:disabled,input:disabled,select:disabled{opacity:.6;cursor:not-allowed}
    /* Fade animation */
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .fade-in{animation:fadeIn .3s ease-in}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <a class="brand" href="index.html" aria-label="Back to Home">
        <img src="assets/logo.png" alt="Neutryx logo">
        <span>Neutryx Lab</span>
      </a>
      <nav>
        <a href="core.html" aria-current="page">Neutryx‑Core</a>
        <a href="ai.html">Neutryx‑AI</a>
        <a href="https://github.com/neutryx-lab" target="_blank" rel="noreferrer noopener">GitHub</a>
        <a href="mailto:contact@neutryx.tech">Contact</a>
      </nav>
    </div>
  </header>

  <main>
    <h1>Neutryx‑Core (Open‑Source)</h1>
    <p>High‑performance numerical engine for pricing/risk/XVA, built on JAX and automatic differentiation.</p>
    <p class="toolbar">
      <a class="btn" href="https://github.com/neutryx-lab/neutryx-core" target="_blank" rel="noreferrer noopener">GitHub Repository →</a>
      <a class="btn" href="https://github.com/neutryx-lab" target="_blank" rel="noreferrer noopener">Organization →</a>
      <span class="pill">Demo: Public API</span>
    </p>

    <section class="note" style="margin:18px 0 22px">
      <strong>License:</strong> Permissive open‑source (e.g., MIT/BSD). No confidential learning logic is included here.
    </section>

    <!-- DEMO GRID -->
    <section class="grid" style="grid-template-columns:repeat(12,1fr);gap:18px">
      <!-- Left: Inputs -->
      <div class="card" style="grid-column:span 7">
        <div class="section">
          <h3>PV / Risk / XVA — Demo Inputs</h3>
          <div class="small mutetext">The API endpoint is configurable. Start with the simple PV demo; swap to /price when wired to neutryx‑core.</div>
        </div>

        <div class="section">
          <div class="row" style="margin-bottom:10px">
            <div class="field">
              <label for="api">API Base</label>
              <input id="api" placeholder="https://neutryx-api.onrender.com" value="https://neutryx-api.onrender.com" />
            </div>
            <div class="field">
              <label for="endpoint">Endpoint</label>
              <select id="endpoint">
                <option value="pv">/pv (simple PV)</option>
                <option value="price">/price (core hook)</option>
                <option value="add">/add (connectivity)</option>
              </select>
            </div>
            <div class="field">
              <label for="product">Product</label>
              <select id="product">
                <option value="vanilla_call">Vanilla Call</option>
                <option value="vanilla_put">Vanilla Put</option>
                <option value="irs">Interest Rate Swap</option>
              </select>
            </div>
            <div class="field" id="field-notional">
              <label for="notional">Notional</label>
              <input id="notional" type="number" value="1000000" step="1000" />
              <div class="error-msg"></div>
            </div>
            <div class="field" id="field-rate">
              <label for="rate">Rate (r)</label>
              <input id="rate" type="number" value="0.02" step="0.005" />
              <div class="error-msg"></div>
            </div>
            <div class="field" id="field-t">
              <label for="t">Maturity (years)</label>
              <input id="t" type="number" value="1.0" step="0.25" />
              <div class="error-msg"></div>
            </div>
          </div>

          <div class="row">
            <div class="field" id="field-spot">
              <label for="spot">Spot</label>
              <input id="spot" type="number" value="100" step="1" />
              <div class="error-msg"></div>
            </div>
            <div class="field" id="field-strike">
              <label for="strike">Strike</label>
              <input id="strike" type="number" value="100" step="1" />
              <div class="error-msg"></div>
            </div>
            <div class="field" id="field-vol">
              <label for="vol">Vol</label>
              <input id="vol" type="number" value="0.2" step="0.01" />
              <div class="error-msg"></div>
            </div>
            <div class="field">
              <label for="model">Model</label>
              <select id="model">
                <option value="bs">Black–Scholes</option>
                <option value="sabr">SABR</option>
              </select>
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button id="btnRun" class="btn primary" type="button">Run computation</button>
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button id="btnSample" class="btn ghost" type="button">Sample params</button>
            </div>
          </div>
        </div>

        <div class="section small mutetext">
          Tips: use <span class="kbd">/add</span> to check connectivity (a+b), <span class="kbd">/pv</span> for discount PV, and switch to <span class="kbd">/price</span> once wired to <em>neutryx‑core</em>.
        </div>
      </div>

      <!-- Right: Results -->
      <div class="card" style="grid-column:span 5">
        <div class="section" style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Results</h3>
          <div class="status"><span id="dot" class="dot muted"></span><span id="label" class="mutetext">idle</span></div>
        </div>
        <div class="section">
          <div class="row" style="grid-template-columns:repeat(3,1fr)">
            <div class="field">
              <label>Latency</label>
              <div id="latency" class="pill">–</div>
            </div>
            <div class="field">
              <label>HTTP</label>
              <div id="status" class="pill">–</div>
            </div>
            <div class="field">
              <label>Endpoint</label>
              <div id="ep" class="pill">–</div>
            </div>
          </div>
        </div>
        <div class="section">
          <h3 style="margin:0 0 8px">Output</h3>
          <div class="code-wrapper">
            <button class="copy-btn" data-target="out" title="Copy to clipboard">Copy</button>
            <pre><code id="out">{ /* run to see output */ }</code></pre>
          </div>
        </div>
        <div class="section">
          <h3 style="margin:0 0 8px">Request</h3>
          <div class="code-wrapper">
            <button class="copy-btn" data-target="req" title="Copy to clipboard">Copy</button>
            <pre><code id="req">{ /* request payload will appear here */ }</code></pre>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>© 2025 Neutryx Lab · University College London</footer>

  <script>
    const $ = (q)=>document.querySelector(q);
    const API = $('#api');
    const EP = $('#endpoint');
    const fields = {
      product: $('#product'), notional: $('#notional'), rate: $('#rate'), t: $('#t'),
      spot: $('#spot'), strike: $('#strike'), vol: $('#vol'), model: $('#model')
    };
    const btnRun = $('#btnRun');
    const btnSample = $('#btnSample');
    const out = $('#out');
    const reqbox = $('#req');
    const dot = $('#dot');
    const label = $('#label');
    const latency = $('#latency');
    const http = $('#status');
    const epdisp = $('#ep');

    function setStatus(kind, text){
      dot.className = 'dot ' + (kind||'muted');
      label.textContent = text||'idle';
    }

    // Validation functions
    function showFieldError(fieldId, message){
      const fieldEl = $(`#field-${fieldId}`);
      if(fieldEl){
        fieldEl.classList.add('field-error');
        const errMsg = fieldEl.querySelector('.error-msg');
        if(errMsg) errMsg.textContent = message;
      }
    }

    function clearFieldError(fieldId){
      const fieldEl = $(`#field-${fieldId}`);
      if(fieldEl){
        fieldEl.classList.remove('field-error');
        const errMsg = fieldEl.querySelector('.error-msg');
        if(errMsg) errMsg.textContent = '';
      }
    }

    function clearAllErrors(){
      ['notional', 'rate', 't', 'spot', 'strike', 'vol'].forEach(clearFieldError);
    }

    function validateField(fieldId, value){
      const val = parseFloat(value);

      if(isNaN(val)){
        showFieldError(fieldId, 'Must be a number');
        return false;
      }

      switch(fieldId){
        case 'notional':
        case 'spot':
        case 'strike':
          if(val <= 0){
            showFieldError(fieldId, 'Must be positive');
            return false;
          }
          break;
        case 'rate':
          if(val < 0 || val > 1){
            showFieldError(fieldId, 'Must be between 0 and 1');
            return false;
          }
          break;
        case 'vol':
          if(val <= 0 || val > 2){
            showFieldError(fieldId, 'Must be between 0 and 2');
            return false;
          }
          break;
        case 't':
          if(val <= 0){
            showFieldError(fieldId, 'Must be positive');
            return false;
          }
          break;
      }

      clearFieldError(fieldId);
      return true;
    }

    function validateAllFields(){
      let valid = true;
      clearAllErrors();

      const validations = [
        ['notional', fields.notional.value],
        ['rate', fields.rate.value],
        ['t', fields.t.value],
        ['spot', fields.spot.value],
        ['strike', fields.strike.value],
        ['vol', fields.vol.value]
      ];

      validations.forEach(([id, val]) => {
        if(!validateField(id, val)) valid = false;
      });

      return valid;
    }

    // Add blur event listeners for real-time validation
    ['notional', 'rate', 't', 'spot', 'strike', 'vol'].forEach(id => {
      fields[id].addEventListener('blur', () => validateField(id, fields[id].value));
      fields[id].addEventListener('input', () => clearFieldError(id));
    });

    // Loading state management
    function setLoading(isLoading){
      btnRun.disabled = isLoading;
      btnSample.disabled = isLoading;

      if(isLoading){
        btnRun.innerHTML = '<span class="spinner"></span> Computing...';
        Object.values(fields).forEach(f => f.disabled = true);
      } else {
        btnRun.textContent = 'Run computation';
        Object.values(fields).forEach(f => f.disabled = false);
      }
    }

    // Copy to clipboard function
    function copyToClipboard(text, button){
      navigator.clipboard.writeText(text).then(() => {
        button.textContent = '✓ Copied';
        button.classList.add('copied');
        setTimeout(() => {
          button.textContent = 'Copy';
          button.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        console.error('Copy failed:', err);
        button.textContent = 'Failed';
        setTimeout(() => button.textContent = 'Copy', 2000);
      });
    }

    // Add copy button event listeners
    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-target');
        const targetEl = $(`#${targetId}`);
        if(targetEl) copyToClipboard(targetEl.textContent, btn);
      });
    });

    function sample(){
      clearAllErrors();
      fields.notional.value = (Math.floor(Math.random()*9)+1) * 1_000_000;
      fields.rate.value = (Math.random()*0.05 + 0.005).toFixed(3);
      fields.t.value = (Math.floor(Math.random()*8)+1).toFixed(2);
      fields.spot.value = (Math.floor(Math.random()*80)+80).toFixed(0);
      fields.strike.value = (Math.floor(Math.random()*80)+80).toFixed(0);
      fields.vol.value = (Math.random()*0.35 + 0.05).toFixed(3);
    }

    async function run(){
      // Validate inputs before running
      if(!validateAllFields()){
        setStatus('err', 'Invalid inputs');
        return;
      }
      const base = API.value.replace(/\/$/,'');
      const endpoint = EP.value;
      epdisp.textContent = '/' + endpoint;
      setStatus('warn','running…');
      setLoading(true);
      http.textContent = '—';
      latency.textContent = '—';

      const t0 = performance.now();

      try{
        let url = `${base}/${endpoint}`;
        let res, payload = null;

        if(endpoint === 'add'){
          const a = 3, b = 5; // connectivity check
          url += `?a=${a}&b=${b}`;
          reqbox.textContent = JSON.stringify({method:'GET', url}, null, 2);
          res = await fetch(url);
        } else if(endpoint === 'pv'){
          const params = new URLSearchParams({
            notional: fields.notional.value,
            rate: fields.rate.value,
            t: fields.t.value
          });
          url += `?${params.toString()}`;
          reqbox.textContent = JSON.stringify({method:'GET', url}, null, 2);
          res = await fetch(url);
        } else { // price (POST)
          const body = {
            product: fields.product.value,
            notional: +fields.notional.value,
            spot: +fields.spot.value,
            strike: +fields.strike.value,
            rate: +fields.rate.value,
            vol: +fields.vol.value,
            maturity: +fields.t.value,
            model: fields.model.value,
            market: null
          };
          reqbox.textContent = JSON.stringify({method:'POST', url, body}, null, 2);
          res = await fetch(url, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });
        }

        const txt = await res.text();
        const t1 = performance.now();
        http.textContent = res.status + ' ' + res.statusText;
        latency.textContent = Math.max(0, t1 - t0).toFixed(0) + ' ms';

        try{
          out.textContent = JSON.stringify(JSON.parse(txt), null, 2);
          out.parentElement.classList.add('fade-in');
        }
        catch{ out.textContent = txt; }

        if(res.ok){
          setStatus('ok', 'success');
        } else {
          setStatus('err', `HTTP ${res.status} error`);
          // Try to parse error message
          try{
            const errData = JSON.parse(txt);
            if(errData.error || errData.message){
              out.textContent = JSON.stringify(errData, null, 2);
            }
          }catch{}
        }
      }catch(e){
        const t1 = performance.now();
        latency.textContent = Math.max(0, t1 - t0).toFixed(0) + ' ms';
        http.textContent = 'Network error';

        let errorMsg = 'Network request failed. ';
        if(e.message.includes('Failed to fetch')){
          errorMsg += 'Check your internet connection or API URL.';
        } else {
          errorMsg += e.message;
        }
        out.textContent = errorMsg;
        setStatus('err','Network error');
      } finally {
        setLoading(false);
      }
    }

    btnRun.addEventListener('click', run);
    btnSample.addEventListener('click', sample);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Enter or Ctrl+Enter to run
      if((e.key === 'Enter' && e.ctrlKey) || (e.key === 'Enter' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT')){
        e.preventDefault();
        if(!btnRun.disabled) run();
      }
      // Escape to clear errors
      if(e.key === 'Escape'){
        clearAllErrors();
        setStatus('muted', 'idle');
      }
    });
  </script>
</body>
</html>
