<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Neutryx‑Core — Interactive Pricer Demo</title>
  <style>
    :root{
      --ink:#0a0a0b; --muted:#666; --bg:#f6f7fb; --card:#fff;
      --brand:#0a66c2; --acc:#5b9cff; --ring:rgba(10,102,194,.25);
      --ok:#0ea75a; --warn:#f5b100; --err:#d93025; --border:#e4e6ef;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg)}
    header{position:sticky;top:0;z-index:50;background:#fff;padding:12px 16px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .wrap{max-width:1080px;margin:0 auto;display:flex;align-items:center;gap:14px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
    .brand img{width:36px;height:36px;object-fit:contain}
    .brand span{font-weight:800;letter-spacing:.2px}
    nav{margin-left:auto;display:flex;gap:14px;flex-wrap:wrap}
    nav a{color:var(--brand);text-decoration:none;font-size:.95rem}
    nav a:hover{text-decoration:underline}
    @media (max-width:768px){
      .wrap{flex-direction:column;align-items:flex-start;gap:12px}
      nav{margin-left:0;width:100%;justify-content:flex-start;gap:12px}
      .brand span{font-size:.95rem}
    }
    main{max-width:1080px;margin:0 auto;padding:24px 16px 64px}
    h1{margin:.3rem 0 .6rem;font-size:2rem}
    p{color:#444;line-height:1.7}
    @media (max-width:640px){
      h1{font-size:1.6rem}
      .toolbar{font-size:.9rem}
    }
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);text-decoration:none;color:var(--brand);background:#fff}
    .btn:hover{box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .note,.box{background:#fff;border-left:4px solid var(--brand);padding:12px 14px;border-radius:12px;box-shadow:0 1px 6px rgba(0,0,0,.05)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    @media (max-width:900px){
      .grid > .card{grid-column:span 12!important}
    }
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.04)}
    .card h3{margin:0 0 8px;font-size:1rem}
    .card .section{padding:16px;border-top:1px solid var(--border)}
    .card .section:first-child{border-top:0;border-top-left-radius:16px;border-top-right-radius:16px}
    .card .section:last-child{border-bottom-left-radius:16px;border-bottom-right-radius:16px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:.9rem;color:#333}
    .row{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
    @media (max-width:768px){
      .row{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:480px){
      .row{grid-template-columns:1fr}
    }
    input,select{appearance:none;width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;outline:none}
    input:focus,select:focus{border-color:var(--acc);box-shadow:0 0 0 4px var(--ring)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .primary{background:var(--brand);color:#fff;border-color:transparent}
    .primary:hover{filter:brightness(.98)}
    .ghost{background:#fff;color:var(--ink)}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#eef2ff;border:1px solid #d4dbff;color:#223;display:inline-block;padding:2px 6px;border-radius:6px}
    .status{display:inline-flex;align-items:center;gap:8px;font-size:.9rem}
    .dot{width:9px;height:9px;border-radius:50%}
    .ok{background:var(--ok)} .warn{background:var(--warn)} .err{background:var(--err)} .muted{background:#bbb}
    .mutetext{color:#666}
    pre{margin:0;background:#0b1020;color:#d7e0ff;border-radius:12px;padding:14px;overflow:auto;border:1px solid #0f1630}
    code{font-family:ui-monospace,Consolas,Menlo,monospace;font-size:.92rem}
    .small{font-size:.9rem;color:#555}
    footer{text-align:center;color:#777;padding:28px 16px 44px}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:.8rem;color:#333}
    /* Validation styles */
    .field-error input,.field-error select{border-color:var(--err);background:#fef2f2}
    .error-msg{color:var(--err);font-size:.85rem;margin-top:4px;display:none}
    .field-error .error-msg{display:block}
    /* Loading spinner */
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Copy button */
    .copy-btn{position:absolute;top:10px;right:10px;padding:4px 8px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:#d7e0ff;font-size:.75rem;cursor:pointer;transition:all .2s}
    .copy-btn:hover{background:rgba(255,255,255,.2)}
    .copy-btn.copied{background:var(--ok);color:#fff;border-color:var(--ok)}
    .code-wrapper{position:relative}
    /* Disabled state */
    button:disabled,input:disabled,select:disabled{opacity:.6;cursor:not-allowed}
    /* Fade animation */
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .fade-in{animation:fadeIn .3s ease-in}
    /* Tabs */
    .tabs{display:flex;gap:8px;border-bottom:2px solid var(--border);margin-bottom:16px}
    .tab{padding:10px 16px;border:none;background:transparent;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s;font-size:.95rem;font-weight:500}
    .tab:hover{color:var(--brand);background:rgba(10,102,194,.05)}
    .tab.active{color:var(--brand);border-bottom-color:var(--brand)}
    .tab-content{display:none}
    .tab-content.active{display:block;animation:fadeIn .3s ease-in}
    @media (max-width:640px){
      .tabs{overflow-x:auto;flex-wrap:nowrap}
      .tab{white-space:nowrap;font-size:.9rem;padding:8px 12px}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <a class="brand" href="index.html" aria-label="Back to Home">
        <img src="assets/logo.png" alt="Neutryx logo">
        <span>Neutryx Lab</span>
      </a>
      <nav>
        <a href="core.html" aria-current="page">Neutryx‑Core</a>
        <a href="ai.html">Neutryx‑AI</a>
        <a href="https://github.com/neutryx-lab" target="_blank" rel="noreferrer noopener">GitHub</a>
        <a href="mailto:contact@neutryx.tech">Contact</a>
      </nav>
    </div>
  </header>

  <main>
    <h1>Neutryx‑Core (Open‑Source)</h1>
    <p>High‑performance numerical engine for pricing/risk/XVA, built on JAX and automatic differentiation.</p>
    <p class="toolbar">
      <a class="btn" href="https://github.com/neutryx-lab/neutryx-core" target="_blank" rel="noreferrer noopener">GitHub Repository →</a>
      <a class="btn" href="https://github.com/neutryx-lab" target="_blank" rel="noreferrer noopener">Organization →</a>
      <span class="pill">Demo: Public API</span>
    </p>

    <section class="note" style="margin:18px 0 22px">
      <strong>License:</strong> Permissive open‑source (e.g., MIT/BSD). No confidential learning logic is included here.
    </section>

    <!-- API URL Configuration -->
    <section class="card" style="margin-bottom:20px">
      <div class="section">
        <div class="row" style="grid-template-columns:1fr auto">
          <div class="field">
            <label for="api-url">API Base URL</label>
            <input id="api-url" type="text" value="https://api.neutryx.tech" placeholder="https://api.neutryx.tech" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button id="btnTest" class="btn ghost" type="button">Test Connection</button>
          </div>
        </div>
      </div>
    </section>

    <!-- DEMO GRID -->
    <section class="grid" style="grid-template-columns:repeat(12,1fr);gap:18px">
      <!-- Left: Inputs -->
      <div class="card" style="grid-column:span 7">
        <div class="section">
          <h3>Demo Inputs</h3>
          <div class="small mutetext">Switch between PV, Risk, and XVA calculations using the tabs below.</div>
        </div>

        <div class="section">
          <!-- Tabs -->
          <div class="tabs">
            <button class="tab active" data-tab="pv">PV</button>
            <button class="tab" data-tab="risk">Risk</button>
            <button class="tab" data-tab="xva">XVA</button>
          </div>

          <!-- PV Tab Content (Swap Price) -->
          <div class="tab-content active" id="pv-content">
            <div class="row" style="margin-bottom:10px">
              <div class="field" id="field-pv-notional">
                <label for="pv-notional">Notional</label>
                <input id="pv-notional" type="number" value="10000000" step="1000" />
                <div class="error-msg"></div>
              </div>
              <div class="field" id="field-pv-fixed-rate">
                <label for="pv-fixed-rate">Fixed Rate</label>
                <input id="pv-fixed-rate" type="number" value="0.024" step="0.001" />
                <div class="error-msg"></div>
              </div>
              <div class="field" id="field-pv-maturity">
                <label for="pv-maturity">Maturity (years)</label>
                <input id="pv-maturity" type="number" value="5" step="0.5" />
                <div class="error-msg"></div>
              </div>
              <div class="field" id="field-pv-pay-freq">
                <label for="pv-pay-freq">Pay Freq (months)</label>
                <select id="pv-pay-freq">
                  <option value="6">6 (Semi-annual)</option>
                  <option value="12">12 (Annual)</option>
                  <option value="3">3 (Quarterly)</option>
                </select>
              </div>
              <div class="field" id="field-pv-pay-fixed">
                <label for="pv-pay-fixed">Pay Fixed</label>
                <select id="pv-pay-fixed">
                  <option value="true">True</option>
                  <option value="false">False</option>
                </select>
              </div>
            </div>
            <div class="small mutetext" style="margin-bottom:8px">Curve (zero rates, cont. compounding):</div>
            <div class="row" style="margin-bottom:10px">
              <div class="field" id="field-pv-curve-1m">
                <label for="pv-curve-1m">1M</label>
                <input id="pv-curve-1m" type="number" value="0.005" step="0.001" />
              </div>
              <div class="field" id="field-pv-curve-3m">
                <label for="pv-curve-3m">3M</label>
                <input id="pv-curve-3m" type="number" value="0.007" step="0.001" />
              </div>
              <div class="field" id="field-pv-curve-6m">
                <label for="pv-curve-6m">6M</label>
                <input id="pv-curve-6m" type="number" value="0.009" step="0.001" />
              </div>
              <div class="field" id="field-pv-curve-1y">
                <label for="pv-curve-1y">1Y</label>
                <input id="pv-curve-1y" type="number" value="0.011" step="0.001" />
              </div>
              <div class="field" id="field-pv-curve-2y">
                <label for="pv-curve-2y">2Y</label>
                <input id="pv-curve-2y" type="number" value="0.015" step="0.001" />
              </div>
              <div class="field" id="field-pv-curve-5y">
                <label for="pv-curve-5y">5Y</label>
                <input id="pv-curve-5y" type="number" value="0.022" step="0.001" />
              </div>
            </div>
          </div>

          <!-- Risk Tab Content (Swap Risks) -->
          <div class="tab-content" id="risk-content">
            <div class="row" style="margin-bottom:10px">
              <div class="field" id="field-risk-notional">
                <label for="risk-notional">Notional</label>
                <input id="risk-notional" type="number" value="10000000" step="1000" />
                <div class="error-msg"></div>
              </div>
              <div class="field" id="field-risk-fixed-rate">
                <label for="risk-fixed-rate">Fixed Rate</label>
                <input id="risk-fixed-rate" type="number" value="0.024" step="0.001" />
                <div class="error-msg"></div>
              </div>
              <div class="field" id="field-risk-maturity">
                <label for="risk-maturity">Maturity (years)</label>
                <input id="risk-maturity" type="number" value="5" step="0.5" />
                <div class="error-msg"></div>
              </div>
              <div class="field" id="field-risk-pay-freq">
                <label for="risk-pay-freq">Pay Freq (months)</label>
                <select id="risk-pay-freq">
                  <option value="6">6 (Semi-annual)</option>
                  <option value="12">12 (Annual)</option>
                  <option value="3">3 (Quarterly)</option>
                </select>
              </div>
              <div class="field" id="field-risk-pay-fixed">
                <label for="risk-pay-fixed">Pay Fixed</label>
                <select id="risk-pay-fixed">
                  <option value="true">True</option>
                  <option value="false">False</option>
                </select>
              </div>
              <div class="field" id="field-risk-bump-bp">
                <label for="risk-bump-bp">Bump (bps)</label>
                <input id="risk-bump-bp" type="number" value="1.0" step="0.1" />
                <div class="error-msg"></div>
              </div>
            </div>
            <div class="small mutetext" style="margin-bottom:8px">Curve (zero rates, cont. compounding):</div>
            <div class="row" style="margin-bottom:10px">
              <div class="field" id="field-risk-curve-1m">
                <label for="risk-curve-1m">1M</label>
                <input id="risk-curve-1m" type="number" value="0.005" step="0.001" />
              </div>
              <div class="field" id="field-risk-curve-3m">
                <label for="risk-curve-3m">3M</label>
                <input id="risk-curve-3m" type="number" value="0.007" step="0.001" />
              </div>
              <div class="field" id="field-risk-curve-6m">
                <label for="risk-curve-6m">6M</label>
                <input id="risk-curve-6m" type="number" value="0.009" step="0.001" />
              </div>
              <div class="field" id="field-risk-curve-1y">
                <label for="risk-curve-1y">1Y</label>
                <input id="risk-curve-1y" type="number" value="0.011" step="0.001" />
              </div>
              <div class="field" id="field-risk-curve-2y">
                <label for="risk-curve-2y">2Y</label>
                <input id="risk-curve-2y" type="number" value="0.015" step="0.001" />
              </div>
              <div class="field" id="field-risk-curve-5y">
                <label for="risk-curve-5y">5Y</label>
                <input id="risk-curve-5y" type="number" value="0.022" step="0.001" />
              </div>
            </div>
          </div>

          <!-- XVA Tab Content -->
          <div class="tab-content" id="xva-content">
            <div class="small mutetext" style="margin-bottom:8px">Swap Parameters:</div>
            <div class="row" style="margin-bottom:10px">
              <div class="field" id="field-xva-notional">
                <label for="xva-notional">Notional</label>
                <input id="xva-notional" type="number" value="10000000" step="1000" />
                <div class="error-msg"></div>
              </div>
              <div class="field" id="field-xva-fixed-rate">
                <label for="xva-fixed-rate">Fixed Rate</label>
                <input id="xva-fixed-rate" type="number" value="0.024" step="0.001" />
                <div class="error-msg"></div>
              </div>
              <div class="field" id="field-xva-maturity">
                <label for="xva-maturity">Maturity (years)</label>
                <input id="xva-maturity" type="number" value="7" step="0.5" />
                <div class="error-msg"></div>
              </div>
              <div class="field" id="field-xva-pay-freq">
                <label for="xva-pay-freq">Pay Freq (months)</label>
                <select id="xva-pay-freq">
                  <option value="6">6 (Semi-annual)</option>
                  <option value="12">12 (Annual)</option>
                  <option value="3">3 (Quarterly)</option>
                </select>
              </div>
            </div>
            <div class="small mutetext" style="margin-bottom:8px">Curve (zero rates):</div>
            <div class="row" style="margin-bottom:10px">
              <div class="field" id="field-xva-curve-1m">
                <label for="xva-curve-1m">1M</label>
                <input id="xva-curve-1m" type="number" value="0.005" step="0.001" />
              </div>
              <div class="field" id="field-xva-curve-1y">
                <label for="xva-curve-1y">1Y</label>
                <input id="xva-curve-1y" type="number" value="0.011" step="0.001" />
              </div>
              <div class="field" id="field-xva-curve-5y">
                <label for="xva-curve-5y">5Y</label>
                <input id="xva-curve-5y" type="number" value="0.022" step="0.001" />
              </div>
              <div class="field" id="field-xva-curve-10y">
                <label for="xva-curve-10y">10Y</label>
                <input id="xva-curve-10y" type="number" value="0.026" step="0.001" />
              </div>
            </div>
            <div class="small mutetext" style="margin-bottom:8px">XVA Parameters:</div>
            <div class="row" style="margin-bottom:10px">
              <div class="field" id="field-xva-lgd-cp">
                <label for="xva-lgd-cp">LGD CP</label>
                <input id="xva-lgd-cp" type="number" value="0.6" step="0.05" />
                <div class="error-msg"></div>
              </div>
              <div class="field" id="field-xva-lgd-own">
                <label for="xva-lgd-own">LGD Own</label>
                <input id="xva-lgd-own" type="number" value="0.6" step="0.05" />
                <div class="error-msg"></div>
              </div>
              <div class="field" id="field-xva-funding">
                <label for="xva-funding">Funding Spread</label>
                <input id="xva-funding" type="number" value="0.002" step="0.001" />
                <div class="error-msg"></div>
              </div>
              <div class="field" id="field-xva-coc">
                <label for="xva-coc">Cost of Capital</label>
                <input id="xva-coc" type="number" value="0.1" step="0.01" />
                <div class="error-msg"></div>
              </div>
              <div class="field" id="field-xva-cap-factor">
                <label for="xva-cap-factor">Capital Factor</label>
                <input id="xva-cap-factor" type="number" value="0.5" step="0.05" />
                <div class="error-msg"></div>
              </div>
              <div class="field" id="field-xva-grid">
                <label for="xva-grid">Grid (months)</label>
                <input id="xva-grid" type="number" value="1" step="1" />
                <div class="error-msg"></div>
              </div>
            </div>
            <div class="small mutetext" style="margin-bottom:8px">Hazard Curves:</div>
            <div class="row" style="margin-bottom:10px">
              <div class="field" id="field-xva-haz-cp-1y">
                <label for="xva-haz-cp-1y">CP 1Y</label>
                <input id="xva-haz-cp-1y" type="number" value="0.01" step="0.001" />
              </div>
              <div class="field" id="field-xva-haz-cp-5y">
                <label for="xva-haz-cp-5y">CP 5Y</label>
                <input id="xva-haz-cp-5y" type="number" value="0.012" step="0.001" />
              </div>
              <div class="field" id="field-xva-haz-cp-10y">
                <label for="xva-haz-cp-10y">CP 10Y</label>
                <input id="xva-haz-cp-10y" type="number" value="0.015" step="0.001" />
              </div>
              <div class="field" id="field-xva-haz-own-1y">
                <label for="xva-haz-own-1y">Own 1Y</label>
                <input id="xva-haz-own-1y" type="number" value="0.008" step="0.001" />
              </div>
              <div class="field" id="field-xva-haz-own-5y">
                <label for="xva-haz-own-5y">Own 5Y</label>
                <input id="xva-haz-own-5y" type="number" value="0.010" step="0.001" />
              </div>
              <div class="field" id="field-xva-haz-own-10y">
                <label for="xva-haz-own-10y">Own 10Y</label>
                <input id="xva-haz-own-10y" type="number" value="0.012" step="0.001" />
              </div>
            </div>
          </div>

          <!-- Engine Toggles (common) -->
          <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
            <div class="small mutetext" style="margin-bottom:8px">Engine Configuration:</div>
            <div class="row" style="grid-template-columns:repeat(3,1fr)">
              <div class="field">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                  <input id="use-jax" type="checkbox" checked />
                  <span>Use JAX</span>
                </label>
              </div>
              <div class="field">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                  <input id="use-jit" type="checkbox" checked />
                  <span>Use JIT</span>
                </label>
              </div>
              <div class="field">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                  <input id="use-aad" type="checkbox" checked />
                  <span>Use AAD</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Action Buttons (common) -->
          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>&nbsp;</label>
              <button id="btnRun" class="btn primary" type="button">Run computation</button>
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button id="btnSample" class="btn ghost" type="button">Sample params</button>
            </div>
          </div>
        </div>

        <div class="section small mutetext">
          <strong>API Endpoints:</strong><br>
          • PV: <code>/swap/price</code> — Swap pricing with fair rate calculation<br>
          • Risk: <code>/swap/risks</code> — DV01 and bucketed sensitivities<br>
          • XVA: <code>/swap/xva</code> — CVA, DVA, FVA, and KVA calculations<br>
          <br>
          <strong>Tips:</strong> Use <span class="kbd">Ctrl+Enter</span> to run, <span class="kbd">Esc</span> to clear errors. Toggle JAX/JIT/AAD to compare performance.
        </div>
      </div>

      <!-- Right: Results -->
      <div class="card" style="grid-column:span 5">
        <div class="section" style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Results</h3>
          <div class="status"><span id="dot" class="dot muted"></span><span id="label" class="mutetext">idle</span></div>
        </div>
        <div class="section">
          <div class="row" style="grid-template-columns:repeat(3,1fr)">
            <div class="field">
              <label>Latency</label>
              <div id="latency" class="pill">–</div>
            </div>
            <div class="field">
              <label>HTTP</label>
              <div id="status" class="pill">–</div>
            </div>
            <div class="field">
              <label>Endpoint</label>
              <div id="ep" class="pill">–</div>
            </div>
          </div>
        </div>
        <div class="section">
          <h3 style="margin:0 0 8px">Output</h3>
          <div class="code-wrapper">
            <button class="copy-btn" data-target="out" title="Copy to clipboard">Copy</button>
            <pre><code id="out">{ /* run to see output */ }</code></pre>
          </div>
        </div>
        <div class="section">
          <h3 style="margin:0 0 8px">Request</h3>
          <div class="code-wrapper">
            <button class="copy-btn" data-target="req" title="Copy to clipboard">Copy</button>
            <pre><code id="req">{ /* request payload will appear here */ }</code></pre>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>© 2025 Neutryx Lab · University College London</footer>

  <script>
    const $ = (q)=>document.querySelector(q);
    const $$ = (q)=>document.querySelectorAll(q);

    // Current active tab
    let activeTab = 'pv';

    // API URL field
    const apiUrl = $('#api-url');
    const btnTest = $('#btnTest');

    // Engine toggles (common)
    const engineToggles = {
      useJax: $('#use-jax'),
      useJit: $('#use-jit'),
      useAad: $('#use-aad')
    };

    // Field references by tab
    const pvFields = {
      notional: $('#pv-notional'),
      fixedRate: $('#pv-fixed-rate'),
      maturity: $('#pv-maturity'),
      payFreq: $('#pv-pay-freq'),
      payFixed: $('#pv-pay-fixed'),
      curve1m: $('#pv-curve-1m'),
      curve3m: $('#pv-curve-3m'),
      curve6m: $('#pv-curve-6m'),
      curve1y: $('#pv-curve-1y'),
      curve2y: $('#pv-curve-2y'),
      curve5y: $('#pv-curve-5y')
    };

    const riskFields = {
      notional: $('#risk-notional'),
      fixedRate: $('#risk-fixed-rate'),
      maturity: $('#risk-maturity'),
      payFreq: $('#risk-pay-freq'),
      payFixed: $('#risk-pay-fixed'),
      bumpBp: $('#risk-bump-bp'),
      curve1m: $('#risk-curve-1m'),
      curve3m: $('#risk-curve-3m'),
      curve6m: $('#risk-curve-6m'),
      curve1y: $('#risk-curve-1y'),
      curve2y: $('#risk-curve-2y'),
      curve5y: $('#risk-curve-5y')
    };

    const xvaFields = {
      notional: $('#xva-notional'),
      fixedRate: $('#xva-fixed-rate'),
      maturity: $('#xva-maturity'),
      payFreq: $('#xva-pay-freq'),
      curve1m: $('#xva-curve-1m'),
      curve1y: $('#xva-curve-1y'),
      curve5y: $('#xva-curve-5y'),
      curve10y: $('#xva-curve-10y'),
      lgdCp: $('#xva-lgd-cp'),
      lgdOwn: $('#xva-lgd-own'),
      funding: $('#xva-funding'),
      coc: $('#xva-coc'),
      capFactor: $('#xva-cap-factor'),
      grid: $('#xva-grid'),
      hazCp1y: $('#xva-haz-cp-1y'),
      hazCp5y: $('#xva-haz-cp-5y'),
      hazCp10y: $('#xva-haz-cp-10y'),
      hazOwn1y: $('#xva-haz-own-1y'),
      hazOwn5y: $('#xva-haz-own-5y'),
      hazOwn10y: $('#xva-haz-own-10y')
    };

    const btnRun = $('#btnRun');
    const btnSample = $('#btnSample');
    const out = $('#out');
    const reqbox = $('#req');
    const dot = $('#dot');
    const label = $('#label');
    const latency = $('#latency');
    const http = $('#status');
    const epdisp = $('#ep');

    function setStatus(kind, text){
      dot.className = 'dot ' + (kind||'muted');
      label.textContent = text||'idle';
    }

    // Tab switching
    function switchTab(tabName){
      activeTab = tabName;

      // Update tab buttons
      $$('.tab').forEach(tab => {
        if(tab.getAttribute('data-tab') === tabName){
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });

      // Update tab content
      $$('.tab-content').forEach(content => {
        if(content.id === `${tabName}-content`){
          content.classList.add('active');
        } else {
          content.classList.remove('active');
        }
      });

      // Clear errors when switching tabs
      clearAllErrors();
      setStatus('muted', 'idle');

      // Update endpoint display
      const endpointMap = {pv: '/swap/price', risk: '/swap/risks', xva: '/swap/xva'};
      epdisp.textContent = endpointMap[tabName] || '–';
    }

    // Add tab click listeners
    $$('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.getAttribute('data-tab');
        switchTab(tabName);
      });
    });

    // Validation functions
    function showFieldError(fieldId, message){
      const fieldEl = $(`#field-${fieldId}`);
      if(fieldEl){
        fieldEl.classList.add('field-error');
        const errMsg = fieldEl.querySelector('.error-msg');
        if(errMsg) errMsg.textContent = message;
      }
    }

    function clearFieldError(fieldId){
      const fieldEl = $(`#field-${fieldId}`);
      if(fieldEl){
        fieldEl.classList.remove('field-error');
        const errMsg = fieldEl.querySelector('.error-msg');
        if(errMsg) errMsg.textContent = '';
      }
    }

    function clearAllErrors(){
      // Clear errors for all numeric input fields
      $$('input[type="number"]').forEach(input => {
        clearFieldError(input.id);
      });
    }

    function validateField(fieldId, value){
      const val = parseFloat(value);

      if(isNaN(val)){
        showFieldError(fieldId, 'Must be a number');
        return false;
      }

      // Basic validation: positive for notional/maturity, 0-1 for rates/lgd
      if(fieldId.includes('notional') || fieldId.includes('maturity') || fieldId.includes('grid')){
        if(val <= 0){
          showFieldError(fieldId, 'Must be positive');
          return false;
        }
      }

      clearFieldError(fieldId);
      return true;
    }

    function validateAllFields(){
      let valid = true;
      clearAllErrors();

      // Validate all numeric inputs in the active tab
      const activeContent = $(`#${activeTab}-content`);
      if(activeContent){
        activeContent.querySelectorAll('input[type="number"]').forEach(input => {
          if(input.value && !validateField(input.id, input.value)){
            valid = false;
          }
        });
      }

      return valid;
    }

    // Add blur event listeners for real-time validation
    $$('input[type="number"]').forEach(input => {
      input.addEventListener('blur', () => validateField(input.id, input.value));
      input.addEventListener('input', () => clearFieldError(input.id));
    });

    // Loading state management
    function setLoading(isLoading){
      btnRun.disabled = isLoading;
      btnSample.disabled = isLoading;

      if(isLoading){
        btnRun.innerHTML = '<span class="spinner"></span> Computing...';
      } else {
        btnRun.textContent = 'Run computation';
      }
    }

    // Build curve object from fields
    function buildCurve(fields, tenors){
      const curve = {};
      tenors.forEach(tenor => {
        const fieldKey = `curve${tenor.replace(/[MY]/g, '').toLowerCase()}`;
        if(fields[fieldKey]){
          curve[tenor] = parseFloat(fields[fieldKey].value);
        }
      });
      return curve;
    }

    // Build swap request object
    function buildSwapRequest(fields, includeCurve = true){
      const swap = {
        notional: parseFloat(fields.notional.value),
        fixed_rate: parseFloat(fields.fixedRate.value),
        maturity_years: parseFloat(fields.maturity.value),
        pay_freq_months: parseInt(fields.payFreq.value),
        pay_fixed: fields.payFixed ? fields.payFixed.value === 'true' : true
      };

      if(includeCurve){
        const tenors = ['1M', '3M', '6M', '1Y', '2Y', '5Y'];
        swap.curve = buildCurve(fields, tenors);
      }

      return swap;
    }

    // Build engine toggles object
    function buildEngineToggles(){
      return {
        use_jax: engineToggles.useJax.checked,
        use_jit: engineToggles.useJit.checked,
        use_aad: engineToggles.useAad.checked
      };
    }

    // Copy to clipboard function
    function copyToClipboard(text, button){
      navigator.clipboard.writeText(text).then(() => {
        button.textContent = '✓ Copied';
        button.classList.add('copied');
        setTimeout(() => {
          button.textContent = 'Copy';
          button.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        console.error('Copy failed:', err);
        button.textContent = 'Failed';
        setTimeout(() => button.textContent = 'Copy', 2000);
      });
    }

    // Add copy button event listeners
    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-target');
        const targetEl = $(`#${targetId}`);
        if(targetEl) copyToClipboard(targetEl.textContent, btn);
      });
    });

    function sample(){
      clearAllErrors();

      const randRate = () => (Math.random()*0.03 + 0.005).toFixed(3);
      const randMaturity = () => (Math.floor(Math.random()*8)+2).toFixed(1);

      if(activeTab === 'pv'){
        pvFields.notional.value = (Math.floor(Math.random()*9)+1) * 10_000_000;
        pvFields.fixedRate.value = (Math.random()*0.02 + 0.015).toFixed(3);
        pvFields.maturity.value = randMaturity();
        // Randomize curve
        pvFields.curve1m.value = randRate();
        pvFields.curve3m.value = (parseFloat(pvFields.curve1m.value) + 0.002).toFixed(3);
        pvFields.curve6m.value = (parseFloat(pvFields.curve3m.value) + 0.002).toFixed(3);
        pvFields.curve1y.value = (parseFloat(pvFields.curve6m.value) + 0.002).toFixed(3);
        pvFields.curve2y.value = (parseFloat(pvFields.curve1y.value) + 0.004).toFixed(3);
        pvFields.curve5y.value = (parseFloat(pvFields.curve2y.value) + 0.007).toFixed(3);
      } else if(activeTab === 'risk'){
        riskFields.notional.value = (Math.floor(Math.random()*9)+1) * 10_000_000;
        riskFields.fixedRate.value = (Math.random()*0.02 + 0.015).toFixed(3);
        riskFields.maturity.value = randMaturity();
        riskFields.bumpBp.value = '1.0';
        // Randomize curve
        riskFields.curve1m.value = randRate();
        riskFields.curve3m.value = (parseFloat(riskFields.curve1m.value) + 0.002).toFixed(3);
        riskFields.curve6m.value = (parseFloat(riskFields.curve3m.value) + 0.002).toFixed(3);
        riskFields.curve1y.value = (parseFloat(riskFields.curve6m.value) + 0.002).toFixed(3);
        riskFields.curve2y.value = (parseFloat(riskFields.curve1y.value) + 0.004).toFixed(3);
        riskFields.curve5y.value = (parseFloat(riskFields.curve2y.value) + 0.007).toFixed(3);
      } else if(activeTab === 'xva'){
        xvaFields.notional.value = (Math.floor(Math.random()*9)+1) * 10_000_000;
        xvaFields.fixedRate.value = (Math.random()*0.02 + 0.015).toFixed(3);
        xvaFields.maturity.value = (Math.floor(Math.random()*8)+3).toFixed(1);
        xvaFields.lgdCp.value = (Math.random()*0.3 + 0.5).toFixed(2);
        xvaFields.lgdOwn.value = (Math.random()*0.3 + 0.5).toFixed(2);
        xvaFields.funding.value = (Math.random()*0.003 + 0.001).toFixed(4);
        xvaFields.hazCp1y.value = (Math.random()*0.005 + 0.008).toFixed(4);
        xvaFields.hazCp5y.value = (parseFloat(xvaFields.hazCp1y.value) + 0.002).toFixed(4);
        xvaFields.hazCp10y.value = (parseFloat(xvaFields.hazCp5y.value) + 0.003).toFixed(4);
        xvaFields.hazOwn1y.value = (Math.random()*0.004 + 0.006).toFixed(4);
        xvaFields.hazOwn5y.value = (parseFloat(xvaFields.hazOwn1y.value) + 0.002).toFixed(4);
        xvaFields.hazOwn10y.value = (parseFloat(xvaFields.hazOwn5y.value) + 0.002).toFixed(4);
      }
    }

    async function run(){
      // Validate inputs before running
      if(!validateAllFields()){
        setStatus('err', 'Invalid inputs');
        return;
      }
      const base = apiUrl.value.replace(/\/$/,'');

      // Determine endpoint based on active tab
      let endpoint;
      let requestBody = {};

      if(activeTab === 'pv'){
        endpoint = 'swap/price';
        requestBody = {
          swap: buildSwapRequest(pvFields, true),
          engine: buildEngineToggles()
        };
      } else if(activeTab === 'risk'){
        endpoint = 'swap/risks';
        requestBody = {
          swap: buildSwapRequest(riskFields, true),
          engine: buildEngineToggles(),
          bump_bp: parseFloat(riskFields.bumpBp.value)
        };
      } else if(activeTab === 'xva'){
        endpoint = 'swap/xva';
        const xvaSwap = buildSwapRequest(xvaFields, false);
        // Add XVA-specific curve
        xvaSwap.curve = {
          '1M': parseFloat(xvaFields.curve1m.value),
          '1Y': parseFloat(xvaFields.curve1y.value),
          '5Y': parseFloat(xvaFields.curve5y.value),
          '10Y': parseFloat(xvaFields.curve10y.value)
        };

        requestBody = {
          swap: xvaSwap,
          xva: {
            lgd_cp: parseFloat(xvaFields.lgdCp.value),
            lgd_own: parseFloat(xvaFields.lgdOwn.value),
            hazard_cp_curve: {
              '1Y': parseFloat(xvaFields.hazCp1y.value),
              '5Y': parseFloat(xvaFields.hazCp5y.value),
              '10Y': parseFloat(xvaFields.hazCp10y.value)
            },
            hazard_own_curve: {
              '1Y': parseFloat(xvaFields.hazOwn1y.value),
              '5Y': parseFloat(xvaFields.hazOwn5y.value),
              '10Y': parseFloat(xvaFields.hazOwn10y.value)
            },
            funding_spread: parseFloat(xvaFields.funding.value),
            cost_of_capital: parseFloat(xvaFields.coc.value),
            capital_factor: parseFloat(xvaFields.capFactor.value),
            grid_months: parseInt(xvaFields.grid.value)
          },
          engine: buildEngineToggles()
        };
      }

      epdisp.textContent = '/' + endpoint;
      setStatus('warn','running…');
      setLoading(true);
      http.textContent = '—';
      latency.textContent = '—';

      const t0 = performance.now();

      try{
        const url = `${base}/${endpoint}`;
        reqbox.textContent = JSON.stringify(requestBody, null, 2);

        const res = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(requestBody)
        });

        const txt = await res.text();
        const t1 = performance.now();
        http.textContent = res.status + ' ' + res.statusText;
        latency.textContent = Math.max(0, t1 - t0).toFixed(0) + ' ms';

        try{
          out.textContent = JSON.stringify(JSON.parse(txt), null, 2);
          out.parentElement.classList.add('fade-in');
        }
        catch{ out.textContent = txt; }

        if(res.ok){
          setStatus('ok', 'success');
        } else {
          setStatus('err', `HTTP ${res.status} error`);
          // Try to parse error message
          try{
            const errData = JSON.parse(txt);
            if(errData.error || errData.message || errData.detail){
              out.textContent = JSON.stringify(errData, null, 2);
            }
          }catch{}
        }
      }catch(e){
        const t1 = performance.now();
        latency.textContent = Math.max(0, t1 - t0).toFixed(0) + ' ms';
        http.textContent = 'Network error';

        let errorMsg = 'Network request failed. ';
        if(e.message.includes('Failed to fetch')){
          errorMsg += 'Check your internet connection or API URL.';
        } else {
          errorMsg += e.message;
        }
        out.textContent = errorMsg;
        setStatus('err','Network error');
      } finally {
        setLoading(false);
      }
    }

    // Test API connection
    async function testConnection(){
      const base = apiUrl.value.replace(/\/$/,'');
      setStatus('warn', 'testing…');
      btnTest.disabled = true;
      btnTest.innerHTML = '<span class="spinner"></span> Testing...';

      try{
        const res = await fetch(`${base}/`);
        const data = await res.json();

        if(res.ok && data.status === 'ok'){
          setStatus('ok', 'API connected');
          alert('✓ API connection successful!\n\n' + JSON.stringify(data, null, 2));
        } else {
          setStatus('err', 'API error');
          alert('✗ API returned unexpected response:\n\n' + JSON.stringify(data, null, 2));
        }
      }catch(e){
        setStatus('err', 'connection failed');
        alert('✗ Connection failed:\n\n' + e.message);
      }finally{
        btnTest.disabled = false;
        btnTest.textContent = 'Test Connection';
      }
    }

    btnRun.addEventListener('click', run);
    btnSample.addEventListener('click', sample);
    btnTest.addEventListener('click', testConnection);

    // Initialize endpoint display
    switchTab('pv');

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Enter or Ctrl+Enter to run
      if((e.key === 'Enter' && e.ctrlKey) || (e.key === 'Enter' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT')){
        e.preventDefault();
        if(!btnRun.disabled) run();
      }
      // Escape to clear errors
      if(e.key === 'Escape'){
        clearAllErrors();
        setStatus('muted', 'idle');
      }
    });
  </script>
</body>
</html>
