<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Neutryx-Core: Interactive Pricer Demo</title>
  <style>
    :root{
      --ink:#0a0a0b; --muted:#666; --bg:#f6f7fb; --card:#fff;
      --brand:#0a66c2; --acc:#5b9cff; --ring:rgba(10,102,194,.25);
      --ok:#0ea75a; --warn:#f5b100; --err:#d93025; --border:#e4e6ef;
    }
    [data-theme="dark"]{
      --ink:#e8eaf0; --muted:#a0a4b8; --bg:#0f1117; --card:#1a1d29;
      --brand:#5b9cff; --acc:#4a8bef; --ring:rgba(91,156,255,.25);
      --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --border:#2a2e3f;
    }
    @media (prefers-color-scheme:dark){
      :root:not([data-theme="light"]){
        --ink:#e8eaf0; --muted:#a0a4b8; --bg:#0f1117; --card:#1a1d29;
        --brand:#5b9cff; --acc:#4a8bef; --ring:rgba(91,156,255,.25);
        --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --border:#2a2e3f;
      }
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg);transition:background .3s,color .3s}
    header{position:sticky;top:0;z-index:50;background:var(--card);padding:12px 16px;box-shadow:0 2px 8px rgba(0,0,0,.06);border-bottom:1px solid var(--border);transition:background .3s,border-color .3s}
    .wrap{max-width:1080px;margin:0 auto;display:flex;align-items:center;gap:14px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
    .brand img{width:36px;height:36px;object-fit:contain}
    .brand span{font-weight:800;letter-spacing:.2px}
    nav{margin-left:auto;display:flex;gap:14px;flex-wrap:wrap}
    nav a{color:var(--brand);text-decoration:none;font-size:.95rem}
    nav a:hover{text-decoration:underline}
    @media (max-width:768px){
      .wrap{flex-direction:column;align-items:flex-start;gap:12px}
      nav{margin-left:0;width:100%;justify-content:flex-start;gap:12px}
      .brand span{font-size:.95rem}
    }
    main{max-width:1080px;margin:0 auto;padding:24px 16px 64px}
    h1{margin:.3rem 0 .6rem;font-size:2rem}
    p{color:#444;line-height:1.7}
    @media (max-width:640px){
      main{padding:16px 12px 48px}
      h1{font-size:1.6rem}
      p{font-size:.95rem}
      .toolbar{font-size:.9rem}
    }
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);text-decoration:none;color:var(--brand);background:var(--card);transition:all .2s}
    .btn:hover{box-shadow:0 2px 10px rgba(0,0,0,.06);transform:translateY(-1px)}
    .note,.box{background:var(--card);border-left:4px solid var(--brand);padding:12px 14px;border-radius:12px;box-shadow:0 1px 6px rgba(0,0,0,.05);transition:background .3s}
    @media (max-width:640px){
      .note,.box{padding:10px 12px;font-size:.95rem}
    }
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    @media (max-width:900px){
      .grid > .card{grid-column:span 12!important}
    }
    @media (max-width:640px){
      .grid{gap:12px}
    }
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.04);transition:all .3s;opacity:0;transform:translateY(20px)}
    .card.fade-in-up{opacity:1;transform:translateY(0)}
    .card h3{margin:0 0 8px;font-size:1rem}
    .card .section{padding:16px;border-top:1px solid var(--border)}
    .card .section:first-child{border-top:0;border-top-left-radius:16px;border-top-right-radius:16px}
    .card .section:last-child{border-bottom-left-radius:16px;border-bottom-right-radius:16px}
    @media (max-width:640px){
      .card{border-radius:12px}
      .card .section{padding:12px}
      .card h3{font-size:.95rem}
    }
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:.9rem;color:var(--ink)}
    .row{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
    @media (max-width:768px){
      .row{grid-template-columns:repeat(2,1fr)}
    }
    @media (min-width:769px) and (max-width:1024px){
      .grid{grid-template-columns:repeat(6,1fr)!important}
      .grid > .card:first-child{grid-column:span 4!important}
      .grid > .card:last-child{grid-column:span 2!important}
      .two-col-layout{grid-template-columns:1fr!important}
    }
    @media (max-width:480px){
      .row{grid-template-columns:1fr}
    }
    input,select{appearance:none;width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--ink);outline:none;transition:all .2s}
    input:focus,select:focus{border-color:var(--acc);box-shadow:0 0 0 4px var(--ring)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .primary{background:var(--brand);color:#fff;border-color:transparent;transition:all .2s}
    .primary:hover{filter:brightness(1.05);transform:translateY(-1px)}
    .ghost{background:var(--card);color:var(--ink);transition:all .2s}
    .ghost:hover{background:var(--bg)}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:var(--bg);border:1px solid var(--border);color:var(--brand);display:inline-block;padding:2px 6px;border-radius:6px;transition:all .3s}
    .status{display:inline-flex;align-items:center;gap:8px;font-size:.9rem}
    .dot{width:9px;height:9px;border-radius:50%;transition:background .2s}
    .ok{background:var(--ok)} .warn{background:var(--warn)} .err{background:var(--err)} .muted{background:var(--muted)}
    .mutetext{color:var(--muted);transition:color .3s}
    pre{margin:0;background:#0b1020;color:#d7e0ff;border-radius:12px;padding:14px;overflow:auto;border:1px solid #0f1630;max-width:100%;word-wrap:break-word;white-space:pre-wrap}
    code{font-family:ui-monospace,Consolas,Menlo,monospace;font-size:.92rem}
    @media (max-width:640px){
      pre{padding:12px;font-size:.85rem}
      code{font-size:.85rem}
    }
    .small{font-size:.9rem;color:var(--muted);transition:color .3s}
    @media (max-width:640px){
      .small{font-size:.85rem;line-height:1.6}
    }
    footer{text-align:center;color:var(--muted);padding:28px 16px 44px;transition:color .3s}
    @media (max-width:640px){
      footer{padding:20px 12px 32px;font-size:.9rem}
    }
    .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--card);font-size:.8rem;color:var(--ink);transition:all .3s}
    /* Dark mode toggle */
    .theme-toggle{position:relative;width:44px;height:44px;border:none;background:transparent;color:var(--ink);cursor:pointer;border-radius:12px;display:flex;align-items:center;justify-content:center;transition:all .2s}
    .theme-toggle:hover{background:var(--bg)}
    .theme-toggle i{width:20px;height:20px}
    /* Validation styles */
    .field-error input,.field-error select{border-color:var(--err);background:rgba(239,68,68,.1)}
    .error-msg{color:var(--err);font-size:.85rem;margin-top:4px;display:none}
    .field-error .error-msg{display:block}
    /* Scroll animations */
    @keyframes slideInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    .scroll-animate{animation:slideInUp .6s ease-out forwards}
    /* Loading spinner */
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Copy button */
    .copy-btn{position:absolute;top:10px;right:10px;padding:4px 8px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:#d7e0ff;font-size:.75rem;cursor:pointer;transition:all .2s}
    .copy-btn:hover{background:rgba(255,255,255,.2)}
    .copy-btn.copied{background:var(--ok);color:#fff;border-color:var(--ok)}
    .code-wrapper{position:relative}
    /* Disabled state */
    button:disabled,input:disabled,select:disabled{opacity:.6;cursor:not-allowed}
    /* Fade animation */
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .fade-in{animation:fadeIn .3s ease-in}
    /* Tabs */
    .tabs{display:flex;gap:8px;border-bottom:2px solid var(--border);margin-bottom:16px}
    .tab{padding:10px 16px;border:none;background:transparent;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s;font-size:.95rem;font-weight:500}
    .tab:hover{color:var(--brand);background:rgba(10,102,194,.05)}
    .tab.active{color:var(--brand);border-bottom-color:var(--brand)}
    .tab-content{display:none}
    .tab-content.active{display:block;animation:fadeIn .3s ease-in}
    @media (max-width:640px){
      .tabs{overflow-x:auto;flex-wrap:nowrap}
      .tab{white-space:nowrap;font-size:.9rem;padding:8px 12px}
    }
    /* Section headers */
    .section-header{font-size:.95rem;font-weight:600;color:var(--brand);margin-bottom:12px;padding-bottom:6px;border-bottom:2px solid var(--border);transition:all .3s}
    /* Two-column layout for PV/Risk */
    .two-col-layout{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    @media (max-width:900px){
      .two-col-layout{grid-template-columns:1fr;gap:16px}
    }
    .col-section{background:rgba(91,156,255,.05);padding:14px;border-radius:12px;border:1px solid var(--border);transition:all .3s}
    [data-theme="light"] .col-section{background:rgba(10,102,194,.02)}
    @media (max-width:640px){
      .col-section{padding:12px}
    }
    /* Three-column layout for XVA */
    .three-col-layout{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    @media (max-width:1200px){
      .three-col-layout{grid-template-columns:1fr 1fr;gap:14px}
    }
    @media (max-width:768px){
      .three-col-layout{grid-template-columns:1fr;gap:14px}
    }
    /* Percentage input styling */
    .pct-input{position:relative}
    .pct-input input{padding-right:30px}
    .pct-input-wrapper{position:relative;display:inline-block;width:100%}
    .pct-symbol{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--muted);pointer-events:none;transition:color .3s}
    /* Toggle switch for frequency */
    .freq-toggle{display:flex;gap:0;border-radius:12px;overflow:hidden;border:1px solid var(--border);background:var(--bg);transition:all .3s}
    .freq-option{flex:1;padding:10px 12px;border:none;background:transparent;color:var(--muted);cursor:pointer;transition:all .2s;font-size:.9rem;font-weight:500}
    .freq-option.active{background:var(--brand);color:#fff}
    .freq-option:hover:not(.active){background:rgba(91,156,255,.15);color:var(--brand)}
    [data-theme="light"] .freq-option:hover:not(.active){background:rgba(10,102,194,.1)}
    @media (max-width:640px){
      .freq-option{padding:12px;font-size:.95rem}
    }
    /* Mobile-friendly input fields */
    @media (max-width:640px){
      input,select{font-size:16px;padding:12px}
      .btn{padding:12px 16px;font-size:1rem}
      .section-header{font-size:.9rem}
      label{font-size:.88rem}
    }
    /* Curve grid responsive */
    @media (max-width:640px){
      .row[style*="grid-template-columns:repeat(3,1fr)"]{grid-template-columns:repeat(2,1fr)!important}
    }
    @media (max-width:400px){
      .row[style*="grid-template-columns:repeat(3,1fr)"]{grid-template-columns:1fr!important}
      .row[style*="grid-template-columns:repeat(2,1fr)"]{grid-template-columns:1fr!important}
    }
    /* API config row */
    .api-config-row{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end}
    @media (max-width:640px){
      .api-config-row{grid-template-columns:1fr;gap:8px}
      .desktop-only{display:none}
    }
    /* Action buttons responsive */
    @media (max-width:640px){
      .actions,.actions .row{grid-template-columns:1fr;gap:8px}
      .actions .field label{display:none}
    }
    /* Results metadata row */
    .results-meta-row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:640px){
      .results-meta-row{grid-template-columns:1fr;gap:10px}
    }
    /* Action buttons */
    .action-buttons{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
    @media (max-width:640px){
      .action-buttons{grid-template-columns:1fr}
    }
    /* Results header */
    .results-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
    .results-header h3{margin:0}
    @media (max-width:400px){
      .results-header{flex-direction:column;align-items:flex-start}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="assets/config.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <a class="brand" href="index.html" aria-label="Back to Home">
        <img src="assets/logo.png" alt="Neutryx logo">
        <span>Neutryx Lab</span>
      </a>
      <nav>
        <a href="core.html" aria-current="page">Neutryx‑Core</a>
        <a href="ai.html">Neutryx‑AI</a>
        <a href="https://github.com/neutryx-lab" target="_blank" rel="noreferrer noopener">GitHub</a>
        <a href="https://github.com/neutryx-lab/neutryx-lab.github.io/issues" target="_blank" rel="noreferrer noopener">Contact</a>
      </nav>
      <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">
        <i data-lucide="sun" class="theme-icon-light"></i>
        <i data-lucide="moon" class="theme-icon-dark" style="display:none"></i>
      </button>
    </div>
  </header>

  <main>
    <h1>Neutryx‑Core (Open‑Source)</h1>
    <p>High‑performance numerical engine for pricing/risk/XVA, built on JAX and automatic differentiation.</p>
    <p class="toolbar">
      <a class="btn" href="https://github.com/neutryx-lab/neutryx-core" target="_blank" rel="noreferrer noopener">GitHub Repository →</a>
      <a class="btn" href="https://github.com/neutryx-lab" target="_blank" rel="noreferrer noopener">Organization →</a>
      <span class="pill">Demo: Public API</span>
    </p>

    <section class="note" style="margin:18px 0 22px">
      <strong>License:</strong> Permissive open‑source (e.g., MIT/BSD). No confidential learning logic is included here.
    </section>

    <!-- DEMO GRID -->
    <section class="grid" style="grid-template-columns:repeat(12,1fr);gap:18px">
      <!-- Left: Inputs -->
      <div class="card" style="grid-column:span 7">
        <div class="section results-header">
          <h3>Demo Inputs</h3>
          <div class="status"><span id="dot" class="dot muted"></span><span id="label" class="mutetext">idle</span></div>
        </div>
        <div class="section">
          <div class="small mutetext">Switch between PV, Risk, and XVA calculations using the tabs below.</div>
        </div>

        <div class="section">
          <!-- Calculation Type Tabs -->
          <div style="margin-bottom:20px">
            <div class="small mutetext" style="margin-bottom:8px">Calculation Type:</div>
            <div class="tabs">
              <button class="tab active" data-tab="pv">PV</button>
              <button class="tab" data-tab="risk">Risk</button>
              <button class="tab" data-tab="xva">XVA</button>
            </div>
          </div>

          <!-- Shared Parameters (always visible) -->
          <div class="two-col-layout">
            <!-- Left column: Swap Details -->
            <div class="col-section">
              <div class="section-header">Swap Details</div>
              <div class="field" id="field-shared-type" style="margin-bottom:12px">
                <label>Type</label>
                <div class="freq-toggle" id="shared-type-toggle">
                  <button type="button" class="freq-option active" data-type="true">Pay Fixed</button>
                  <button type="button" class="freq-option" data-type="false">Receive Fixed</button>
                </div>
              </div>
              <div class="field" id="field-shared-notional" style="margin-bottom:12px">
                <label for="shared-notional">Notional</label>
                <input id="shared-notional" type="text" value="10,000,000" />
                <div class="error-msg"></div>
              </div>
              <div class="field" id="field-shared-fixed-rate" style="margin-bottom:12px">
                <label for="shared-fixed-rate">Fixed Rate</label>
                <div class="pct-input-wrapper">
                  <input id="shared-fixed-rate" type="number" value="2.4" step="0.1" />
                  <span class="pct-symbol">%</span>
                </div>
                <div class="error-msg"></div>
              </div>
              <div class="field" id="field-shared-pay-freq" style="margin-bottom:12px">
                <label for="shared-pay-freq">Pay Freq</label>
                <div class="freq-toggle" id="shared-pay-freq-toggle">
                  <button type="button" class="freq-option" data-freq="3">3M</button>
                  <button type="button" class="freq-option active" data-freq="6">6M</button>
                  <button type="button" class="freq-option" data-freq="12">12M</button>
                </div>
              </div>
              <div class="field" id="field-shared-maturity" style="margin-bottom:12px">
                <label for="shared-maturity">Maturity (years)</label>
                <input id="shared-maturity" type="number" value="5" step="0.5" min="0.5" />
                <div class="error-msg"></div>
              </div>
            </div>

            <!-- Right column: Zero Rate Curve -->
            <div class="col-section">
              <div class="section-header">Zero Rate Curve</div>
              <div class="row" style="grid-template-columns:repeat(3,1fr)">
                <div class="field" id="field-shared-curve-3m" style="margin-bottom:12px">
                  <label for="shared-curve-3m">3M</label>
                  <div class="pct-input-wrapper">
                    <input id="shared-curve-3m" type="number" value="0.7" step="0.1" />
                    <span class="pct-symbol">%</span>
                  </div>
                </div>
                <div class="field" id="field-shared-curve-6m" style="margin-bottom:12px">
                  <label for="shared-curve-6m">6M</label>
                  <div class="pct-input-wrapper">
                    <input id="shared-curve-6m" type="number" value="0.9" step="0.1" />
                    <span class="pct-symbol">%</span>
                  </div>
                </div>
                <div class="field" id="field-shared-curve-1y" style="margin-bottom:12px">
                  <label for="shared-curve-1y">1Y</label>
                  <div class="pct-input-wrapper">
                    <input id="shared-curve-1y" type="number" value="1.1" step="0.1" />
                    <span class="pct-symbol">%</span>
                  </div>
                </div>
                <div class="field" id="field-shared-curve-2y" style="margin-bottom:12px">
                  <label for="shared-curve-2y">2Y</label>
                  <div class="pct-input-wrapper">
                    <input id="shared-curve-2y" type="number" value="1.5" step="0.1" />
                    <span class="pct-symbol">%</span>
                  </div>
                </div>
                <div class="field" id="field-shared-curve-5y" style="margin-bottom:12px">
                  <label for="shared-curve-5y">5Y</label>
                  <div class="pct-input-wrapper">
                    <input id="shared-curve-5y" type="number" value="2.2" step="0.1" />
                    <span class="pct-symbol">%</span>
                  </div>
                </div>
                <div class="field" id="field-shared-curve-10y" style="margin-bottom:12px">
                  <label for="shared-curve-10y">10Y</label>
                  <div class="pct-input-wrapper">
                    <input id="shared-curve-10y" type="number" value="2.6" step="0.1" />
                    <span class="pct-symbol">%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- XVA-specific Parameters (shown only when XVA tab is active) -->
          <div id="xva-specific-params" style="display:none;margin-top:16px">
            <div class="two-col-layout">
              <!-- Left: XVA Parameters -->
              <div class="col-section">
                <div class="section-header">XVA Parameters</div>
                <div class="row" style="grid-template-columns:repeat(2,1fr)">
                  <div class="field" id="field-xva-lgd-cp" style="margin-bottom:12px">
                    <label for="xva-lgd-cp">LGD CP</label>
                    <div class="pct-input-wrapper">
                      <input id="xva-lgd-cp" type="number" value="60" step="5" />
                      <span class="pct-symbol">%</span>
                    </div>
                    <div class="error-msg"></div>
                  </div>
                  <div class="field" id="field-xva-lgd-own" style="margin-bottom:12px">
                    <label for="xva-lgd-own">LGD Own</label>
                    <div class="pct-input-wrapper">
                      <input id="xva-lgd-own" type="number" value="60" step="5" />
                      <span class="pct-symbol">%</span>
                    </div>
                    <div class="error-msg"></div>
                  </div>
                  <div class="field" id="field-xva-funding" style="margin-bottom:12px">
                    <label for="xva-funding">Funding Spread</label>
                    <div class="pct-input-wrapper">
                      <input id="xva-funding" type="number" value="20" step="1" />
                      <span class="pct-symbol">bp</span>
                    </div>
                    <div class="error-msg"></div>
                  </div>
                  <div class="field" id="field-xva-coc" style="margin-bottom:12px">
                    <label for="xva-coc">Cost of Capital</label>
                    <div class="pct-input-wrapper">
                      <input id="xva-coc" type="number" value="10" step="1" />
                      <span class="pct-symbol">%</span>
                    </div>
                    <div class="error-msg"></div>
                  </div>
                  <div class="field" id="field-xva-cap-factor" style="margin-bottom:12px">
                    <label for="xva-cap-factor">Capital Factor</label>
                    <div class="pct-input-wrapper">
                      <input id="xva-cap-factor" type="number" value="50" step="5" />
                      <span class="pct-symbol">%</span>
                    </div>
                    <div class="error-msg"></div>
                  </div>
                  <div class="field" id="field-xva-sim-vol" style="margin-bottom:12px">
                    <label for="xva-sim-vol">Simulation Vol (Normal)</label>
                    <div class="pct-input-wrapper">
                      <input id="xva-sim-vol" type="number" value="50" step="5" />
                      <span class="pct-symbol">bp</span>
                    </div>
                    <div class="error-msg"></div>
                  </div>
                </div>
              </div>

              <!-- Right: Hazard Curves -->
              <div class="col-section">
                <div class="section-header">Hazard Curves</div>
                <div style="margin-bottom:14px">
                  <div class="small mutetext" style="margin-bottom:8px">Counterparty:</div>
                  <div class="row" style="grid-template-columns:repeat(3,1fr)">
                    <div class="field" style="margin-bottom:12px">
                      <label for="xva-haz-cp-1y">1Y</label>
                      <div class="pct-input-wrapper">
                        <input id="xva-haz-cp-1y" type="number" value="1.0" step="0.1" />
                        <span class="pct-symbol">%</span>
                      </div>
                    </div>
                    <div class="field" style="margin-bottom:12px">
                      <label for="xva-haz-cp-5y">5Y</label>
                      <div class="pct-input-wrapper">
                        <input id="xva-haz-cp-5y" type="number" value="1.2" step="0.1" />
                        <span class="pct-symbol">%</span>
                      </div>
                    </div>
                    <div class="field" style="margin-bottom:12px">
                      <label for="xva-haz-cp-10y">10Y</label>
                      <div class="pct-input-wrapper">
                        <input id="xva-haz-cp-10y" type="number" value="1.5" step="0.1" />
                        <span class="pct-symbol">%</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div>
                  <div class="small mutetext" style="margin-bottom:8px">Own:</div>
                  <div class="row" style="grid-template-columns:repeat(3,1fr)">
                    <div class="field" style="margin-bottom:12px">
                      <label for="xva-haz-own-1y">1Y</label>
                      <div class="pct-input-wrapper">
                        <input id="xva-haz-own-1y" type="number" value="0.8" step="0.1" />
                        <span class="pct-symbol">%</span>
                      </div>
                    </div>
                    <div class="field" style="margin-bottom:12px">
                      <label for="xva-haz-own-5y">5Y</label>
                      <div class="pct-input-wrapper">
                        <input id="xva-haz-own-5y" type="number" value="1.0" step="0.1" />
                        <span class="pct-symbol">%</span>
                      </div>
                    </div>
                    <div class="field" style="margin-bottom:12px">
                      <label for="xva-haz-own-10y">10Y</label>
                      <div class="pct-input-wrapper">
                        <input id="xva-haz-own-10y" type="number" value="1.2" step="0.1" />
                        <span class="pct-symbol">%</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons (common) -->
          <div class="action-buttons">
            <button id="btnRun" class="btn primary" type="button">Run computation</button>
            <button id="btnSample" class="btn ghost" type="button">Sample params</button>
          </div>

          <!-- XVA-specific Monte Carlo button -->
          <div id="xva-mc-button-container" class="action-buttons" style="display:none;margin-top:12px">
            <button id="btnXVAMC" class="btn primary" type="button" style="background:var(--acc)">XVA Risks (AAD Monte Carlo)</button>
          </div>
        </div>

        <div class="section small mutetext">
          <strong>API Endpoints:</strong><br>
          • PV: <code>/swap/price</code> - Swap pricing with fair rate calculation<br>
          • Risk: <code>/swap/risks</code> - DV01 and bucketed sensitivities<br>
          • XVA: <code>/swap/xva</code> - CVA, DVA, FVA, and KVA calculations<br>
          • XVA Risks: <code>/swap/xva_risks</code> - XVA risk sensitivities via pathwise AAD Monte Carlo<br>
          <br>
          <strong>Demo Note:</strong> This demo runs on a heavily constrained CPU setup. Production deployments with GPU/TPU acceleration would deliver significantly faster performance. Simplified parameters are used for demonstration. Real-world implementations include additional risk factors and market data.<br>
          <br>
          <strong>Tips:</strong> Use <span class="kbd">Ctrl+Enter</span> to run, <span class="kbd">Esc</span> to clear errors. All computations run across 3 engine configurations (Baseline, JIT, AAD+JIT) to compare performance.
        </div>
      </div>

      <!-- Right: Results -->
      <div class="card" style="grid-column:span 5">
        <div class="section">
          <h3>Results</h3>
        </div>
        <div class="section" id="parsed-results">
          <div class="small mutetext" style="text-align:center;padding:20px">Run computation to see results</div>
        </div>
      </div>
    </section>

    <!-- Raw Data Section (Full Width) -->
    <section class="grid" style="grid-template-columns:1fr;gap:18px;margin-top:18px">
      <div class="card">
        <div class="section">
          <h3>Raw Data</h3>
          <div class="small mutetext">Request payload and API response</div>
        </div>
        <div class="section">
          <h3 style="margin:0 0 8px">Response</h3>
          <div class="code-wrapper">
            <button class="copy-btn" data-target="out" title="Copy to clipboard">Copy</button>
            <pre><code id="out">{ /* run to see output */ }</code></pre>
          </div>
        </div>
        <div class="section">
          <h3 style="margin:0 0 8px">Request</h3>
          <div class="code-wrapper">
            <button class="copy-btn" data-target="req" title="Copy to clipboard">Copy</button>
            <pre><code id="req">{ /* request payload will appear here */ }</code></pre>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>© 2025 Neutryx Lab · University College London</footer>

  <script>
    const $ = (q)=>document.querySelector(q);
    const $$ = (q)=>document.querySelectorAll(q);

    // Dark mode functionality
    function initTheme(){
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = saved || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
      updateThemeIcon(theme);
    }

    function updateThemeIcon(theme){
      const lightIcon = $('.theme-icon-light');
      const darkIcon = $('.theme-icon-dark');
      if(theme === 'dark'){
        lightIcon.style.display = 'none';
        darkIcon.style.display = 'block';
      } else {
        lightIcon.style.display = 'block';
        darkIcon.style.display = 'none';
      }
    }

    function toggleTheme(){
      const current = document.documentElement.getAttribute('data-theme') || 'light';
      const next = current === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeIcon(next);
    }

    // Scroll animations
    function initScrollAnimations(){
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if(entry.isIntersecting){
            entry.target.classList.add('fade-in-up');
            observer.unobserve(entry.target);
          }
        });
      }, {threshold: 0.1});

      $$('.card').forEach(card => {
        observer.observe(card);
      });
    }

    // Current active tab
    let activeTab = 'pv';

    // API URL (from config.js)
    const API_BASE_URL = CONFIG.API_BASE_URL;

    /**
     * Fetch with timeout and debug logging
     * @param {string} url - The URL to fetch
     * @param {object} options - Fetch options
     * @param {number} timeout - Timeout in milliseconds (default: CONFIG.API_TIMEOUT)
     * @returns {Promise<Response>}
     */
    async function fetchWithTimeout(url, options = {}, timeout = CONFIG.API_TIMEOUT) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);

      if (CONFIG.ENABLE_DEBUG) {
        console.log('[API Request]', {
          url,
          method: options.method || 'GET',
          headers: options.headers,
          body: options.body ? JSON.parse(options.body) : null,
          timeout
        });
      }

      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        if (CONFIG.ENABLE_DEBUG) {
          console.log('[API Response]', {
            url,
            status: response.status,
            statusText: response.statusText,
            ok: response.ok
          });
        }

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          if (CONFIG.ENABLE_DEBUG) {
            console.error('[API Timeout]', { url, timeout });
          }
          throw new Error(`Request timeout after ${timeout}ms`);
        }
        if (CONFIG.ENABLE_DEBUG) {
          console.error('[API Error]', { url, error: error.message });
        }
        throw error;
      } finally {
        clearTimeout(timeoutId);
      }
    }

    // Shared pay frequency and type (single set for all calculation types)
    let sharedPayFreq = 6;
    let sharedPayType = 'true'; // 'true' = Pay Fixed, 'false' = Receive Fixed

    // Shared field references (used for all calculation types)
    const sharedFields = {
      notional: $('#shared-notional'),
      fixedRate: $('#shared-fixed-rate'),
      maturity: $('#shared-maturity'),
      curve3m: $('#shared-curve-3m'),
      curve6m: $('#shared-curve-6m'),
      curve1y: $('#shared-curve-1y'),
      curve2y: $('#shared-curve-2y'),
      curve5y: $('#shared-curve-5y'),
      curve10y: $('#shared-curve-10y')
    };

    // XVA-specific field references
    const xvaFields = {
      lgdCp: $('#xva-lgd-cp'),
      lgdOwn: $('#xva-lgd-own'),
      funding: $('#xva-funding'),
      coc: $('#xva-coc'),
      capFactor: $('#xva-cap-factor'),
      simVol: $('#xva-sim-vol'),
      hazCp1y: $('#xva-haz-cp-1y'),
      hazCp5y: $('#xva-haz-cp-5y'),
      hazCp10y: $('#xva-haz-cp-10y'),
      hazOwn1y: $('#xva-haz-own-1y'),
      hazOwn5y: $('#xva-haz-own-5y'),
      hazOwn10y: $('#xva-haz-own-10y')
    };

    const btnRun = $('#btnRun');
    const btnSample = $('#btnSample');
    const out = $('#out');
    const reqbox = $('#req');
    const dot = $('#dot');
    const label = $('#label');

    function setStatus(kind, text){
      dot.className = 'dot ' + (kind||'muted');
      label.textContent = text||'idle';
    }

    // Tab switching
    function switchTab(tabName){
      activeTab = tabName;

      // Update tab buttons
      $$('.tab').forEach(tab => {
        if(tab.getAttribute('data-tab') === tabName){
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });

      // Show/hide XVA-specific parameters
      const xvaParams = $('#xva-specific-params');
      if(xvaParams){
        xvaParams.style.display = (tabName === 'xva') ? 'block' : 'none';
      }

      // Show/hide XVA MC button
      const xvaMCContainer = $('#xva-mc-button-container');
      if(xvaMCContainer){
        xvaMCContainer.style.display = (tabName === 'xva') ? 'flex' : 'none';
      }

      // Clear errors when switching tabs
      clearAllErrors();
      setStatus('muted', 'idle');
    }

    // Add tab click listeners
    $$('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.getAttribute('data-tab');
        switchTab(tabName);
      });
    });

    // Add frequency and type toggle listeners for shared form
    $$('.freq-toggle').forEach(toggle => {
      const buttons = toggle.querySelectorAll('.freq-option');
      const toggleId = toggle.id;

      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          // Remove active from all buttons in this toggle
          buttons.forEach(b => b.classList.remove('active'));
          // Add active to clicked button
          btn.classList.add('active');

          // Update the shared variables
          const freq = btn.getAttribute('data-freq');
          const type = btn.getAttribute('data-type');

          if(freq){
            // Pay frequency toggle
            sharedPayFreq = parseInt(freq);
            saveFormState(); // Save to localStorage
          } else if(type){
            // Type toggle (Pay Fixed / Receive Fixed)
            sharedPayType = type;
            saveFormState(); // Save to localStorage
          }
        });
      });
    });

    // Validation functions
    function showFieldError(fieldId, message){
      const fieldEl = $(`#field-${fieldId}`);
      if(fieldEl){
        fieldEl.classList.add('field-error');
        const errMsg = fieldEl.querySelector('.error-msg');
        if(errMsg) errMsg.textContent = message;
      }
    }

    function clearFieldError(fieldId){
      const fieldEl = $(`#field-${fieldId}`);
      if(fieldEl){
        fieldEl.classList.remove('field-error');
        const errMsg = fieldEl.querySelector('.error-msg');
        if(errMsg) errMsg.textContent = '';
      }
    }

    function clearAllErrors(){
      // Clear errors for all numeric input fields
      $$('input[type="number"]').forEach(input => {
        clearFieldError(input.id);
      });
    }

    function validateField(fieldId, value){
      // Handle notional fields (with commas)
      const val = fieldId.includes('notional') ? parseNotional(value) : parseFloat(value);

      if(isNaN(val)){
        showFieldError(fieldId, 'Must be a number');
        return false;
      }

      // Basic validation: positive for notional/maturity, 0-1 for rates/lgd
      if(fieldId.includes('notional') || fieldId.includes('maturity') || fieldId.includes('grid')){
        if(val <= 0){
          showFieldError(fieldId, 'Must be positive');
          return false;
        }
      }

      clearFieldError(fieldId);
      return true;
    }

    function validateAllFields(){
      let valid = true;
      clearAllErrors();

      // Validate shared fields (always)
      Object.values(sharedFields).forEach(field => {
        if(field && field.value && !validateField(field.id, field.value)){
          valid = false;
        }
      });

      // Validate XVA-specific fields if XVA tab is active
      if(activeTab === 'xva'){
        Object.values(xvaFields).forEach(field => {
          if(field && field.value && !validateField(field.id, field.value)){
            valid = false;
          }
        });
      }

      // Additional validation: Maturity must be multiple of Pay Freq
      if(sharedFields.maturity){
        const maturity = parseFloat(sharedFields.maturity.value);
        const maturityMonths = maturity * 12;

        if(maturityMonths % sharedPayFreq !== 0){
          showFieldError(sharedFields.maturity.id, `Maturity must be a multiple of payment frequency (${sharedPayFreq} months)`);
          valid = false;
        }
      }

      return valid;
    }

    // Add blur event listeners for real-time validation
    $$('input[type="number"]').forEach(input => {
      input.addEventListener('blur', () => validateField(input.id, input.value));
      input.addEventListener('input', () => clearFieldError(input.id));
    });

    // Add formatting for Notional fields (text inputs with commas)
    $$('input[type="text"]').forEach(input => {
      if(input.id.includes('notional')){
        input.addEventListener('blur', () => {
          const num = parseNotional(input.value);
          if(!isNaN(num) && num > 0){
            input.value = formatNotional(num);
          }
        });
        input.addEventListener('focus', () => {
          // Remove commas on focus for easier editing
          input.value = input.value.replace(/,/g, '');
        });
      }
    });

    // Loading state management
    function setLoading(isLoading){
      btnRun.disabled = isLoading;
      btnSample.disabled = isLoading;

      if(isLoading){
        btnRun.innerHTML = '<span class="spinner"></span> Computing...';
      } else {
        btnRun.textContent = 'Run computation';
      }
    }

    // Helper: Convert percentage to decimal (2.4% → 0.024)
    // Round to 8 decimal places to avoid floating point precision issues
    function pctToDecimal(pct){
      return parseFloat((parseFloat(pct) / 100).toFixed(8));
    }

    // Helper: Convert basis points to decimal (50bp → 0.005)
    function bpToDecimal(bp){
      return parseFloat((parseFloat(bp) / 10000).toFixed(8));
    }

    // Helper: Convert decimal to percentage (0.024 → 2.4)
    function decimalToPct(dec){
      return (parseFloat(dec) * 100).toFixed(2);
    }

    // Helper: Parse notional with comma support (10,000,000 → 10000000)
    function parseNotional(str){
      return parseFloat(str.replace(/,/g, ''));
    }

    // Helper: Format notional with commas (10000000 → 10,000,000)
    function formatNotional(num){
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // Build curve object from fields
    function buildCurve(fields, tenors){
      const curve = {};
      tenors.forEach(tenor => {
        const fieldKey = `curve${tenor.toLowerCase()}`;
        if(fields[fieldKey]){
          // Convert percentage to decimal
          curve[tenor] = pctToDecimal(fields[fieldKey].value);
        }
      });
      return curve;
    }

    // Build swap request object
    function buildSwapRequest(fields, payFreqMonths, payType, includeCurve = true){
      const swap = {
        notional: parseNotional(fields.notional.value),
        fixed_rate: pctToDecimal(fields.fixedRate.value),
        maturity_years: parseFloat(fields.maturity.value),
        pay_freq_months: payFreqMonths,
        pay_fixed: payType === 'true'
      };

      if(includeCurve){
        const tenors = ['3M', '6M', '1Y', '2Y', '5Y', '10Y'];
        swap.curve = buildCurve(fields, tenors);
      }

      return swap;
    }

    // Copy to clipboard function
    function copyToClipboard(text, button){
      navigator.clipboard.writeText(text).then(() => {
        button.textContent = '✓ Copied';
        button.classList.add('copied');
        setTimeout(() => {
          button.textContent = 'Copy';
          button.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        console.error('Copy failed:', err);
        button.textContent = 'Failed';
        setTimeout(() => button.textContent = 'Copy', 2000);
      });
    }

    // Add copy button event listeners
    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-target');
        const targetEl = $(`#${targetId}`);
        if(targetEl) copyToClipboard(targetEl.textContent, btn);
      });
    });

    // Draw XVA exposure chart
    let xvaChart = null; // Store chart instance for cleanup

    function drawXVAExposureChart(baseline){
      const canvas = $('#xva-exposure-chart');
      if(!canvas) return;

      // Destroy previous chart if exists
      if(xvaChart){
        xvaChart.destroy();
      }

      const ctx = canvas.getContext('2d');

      // Convert ENE to negative values for display
      const negativeENE = baseline.ENE.map(v => -v);

      xvaChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: baseline.grid_times,
          datasets: [
            {
              label: 'EPE',
              data: baseline.EPE,
              backgroundColor: 'rgba(10, 102, 194, 0.7)',
              borderWidth: 0,
              barPercentage: 0.9,
              categoryPercentage: 0.95
            },
            {
              label: 'ENE',
              data: negativeENE,
              backgroundColor: 'rgba(217, 48, 37, 0.7)',
              borderWidth: 0,
              barPercentage: 0.9,
              categoryPercentage: 0.95
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: {
              display: false  // Hide legend
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: {
                size: 13
              },
              bodyFont: {
                size: 12
              },
              callbacks: {
                title: function(context) {
                  return `Time: ${context[0].parsed.x.toFixed(2)} years`;
                },
                label: function(context) {
                  const label = context.dataset.label || '';
                  // Show absolute value for ENE
                  const value = Math.abs(context.parsed.y);
                  return `${label}: ${formatNotional(Math.round(value))}`;
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Years',
                font: {
                  size: 12,
                  weight: '600'
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            y: {
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                callback: function(value) {
                  return formatNotional(Math.abs(value));
                }
              }
            }
          },
          // Add custom plugin to draw EPE/ENE labels
          plugins: [{
            id: 'exposureLabels',
            afterDraw: (chart) => {
              const ctx = chart.ctx;
              const chartArea = chart.chartArea;

              ctx.save();
              ctx.font = '600 13px sans-serif';
              ctx.textAlign = 'right';

              // EPE label (top right of positive area)
              ctx.fillStyle = 'rgb(10, 102, 194)';
              ctx.fillText('EPE', chartArea.right - 10, chartArea.top + 20);

              // ENE label (bottom right of negative area)
              ctx.fillStyle = 'rgb(217, 48, 37)';
              ctx.fillText('ENE', chartArea.right - 10, chartArea.bottom - 10);

              ctx.restore();
            }
          }]
        }
      });
    }

    // Display parsed results in a formatted way
    function displayParsedResults(data){
      const container = $('#parsed-results');
      if(!data){
        container.innerHTML = '<div class="small mutetext" style="text-align:center;padding:20px">No results to display</div>';
        return;
      }

      let html = '';

      if(activeTab === 'pv'){
        html += formatPVResults(data);
      } else if(activeTab === 'risk'){
        html += formatRiskResults(data);
      } else if(activeTab === 'xva'){
        html += formatXVAResults(data);
      }

      container.innerHTML = html;

      // Draw XVA exposure chart if available (with slight delay to ensure DOM is ready)
      if(activeTab === 'xva' && data){
        const baseline = Array.isArray(data) ? data[0] : data;
        if(baseline.EPE && baseline.ENE && baseline.grid_times){
          // Use setTimeout to ensure canvas is fully rendered with correct size
          setTimeout(() => drawXVAExposureChart(baseline), 0);
        }
      }
    }

    // Format PV results
    function formatPVResults(data){
      // If data is an array of engine results, use the first one as baseline for values
      const baseline = Array.isArray(data) ? data[0] : data;
      const engines = Array.isArray(data) ? data : [data];

      let html = `
        <div class="field" style="margin-bottom:12px">
          <label>Present Value</label>
          <div style="font-size:1.4em;font-weight:600;color:var(--brand)">${formatNotional(Math.round(baseline.pv || 0))}</div>
        </div>
        <div class="field" style="margin-bottom:12px">
          <label>Fair Rate</label>
          <div style="font-size:1.2em;font-weight:500">${decimalToPct(baseline.fair_rate || 0)}%</div>
        </div>
      `;

      // Display computation times for all engines
      if(Array.isArray(data) && data.length > 1){
        html += '<div class="field" style="margin-bottom:8px"><label>Computation Time</label>';
        html += '<div style="display:grid;gap:8px;margin-top:8px">';

        engines.forEach((engine) => {
          const name = engine.engineName || 'Unknown';
          html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:rgba(10,102,194,0.05);border-radius:8px">`;
          html += `<span style="font-size:0.9em;color:var(--muted)">${name}:</span>`;
          html += `<span class="pill">${(engine.latency_ms || 0).toFixed(2)} ms</span>`;
          html += `</div>`;
        });

        html += '</div></div>';
      } else {
        const engineLabel = baseline.engineName ? ` (${baseline.engineName})` : '';
        html += `<div class="field" style="margin-bottom:8px">
          <label>Computation Time${engineLabel}</label>
          <div class="pill">${(baseline.latency_ms || 0).toFixed(2)} ms</div>
        </div>`;
      }

      return html;
    }

    // Format Risk results
    function formatRiskResults(data){
      const baseline = Array.isArray(data) ? data[0] : data;
      const engines = Array.isArray(data) ? data : [data];

      // DEBUG: Log the baseline structure to see what fields are available
      if (CONFIG.ENABLE_DEBUG) {
        console.log('=== Risk Results Debug ===');
        console.log('Baseline object:', baseline);
        console.log('Available keys:', Object.keys(baseline));
      }

      // Extract DV01 and bucketed risks
      // API returns: dv01_parallel (total) and bucket_pv01 (bucketed)
      const dv01 = baseline.dv01_parallel || baseline.dv01 || baseline.total_dv01 || 0;
      const bucketedRisks = baseline.bucket_pv01 || baseline.bucketed_dv01 || baseline.bucketed_risks || baseline.risks || {};

      if (CONFIG.ENABLE_DEBUG) {
        console.log('Extracted dv01:', dv01);
        console.log('Extracted bucketedRisks:', bucketedRisks);
        console.log('========================');
      }

      let html = `
        <div class="field" style="margin-bottom:12px">
          <label>Total DV01</label>
          <div style="font-size:1.4em;font-weight:600;color:var(--brand)">${formatNotional(Math.round(dv01))}</div>
        </div>
      `;

      // Display grid-level (bucketed) risks
      if(Object.keys(bucketedRisks).length > 0){
        html += '<div class="field" style="margin-bottom:12px">';
        html += '<label>Bucketed DV01 (Grid Risks)</label>';
        html += '<div class="bucketed-risks-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;font-size:0.9em;margin-top:8px">';

        // Sort tenors for better display
        const sortedTenors = Object.keys(bucketedRisks).sort((a, b) => {
          const getMonths = (tenor) => {
            if(tenor.includes('M')) return parseInt(tenor);
            if(tenor.includes('Y')) return parseInt(tenor) * 12;
            return 0;
          };
          return getMonths(a) - getMonths(b);
        });

        for(const tenor of sortedTenors){
          const value = bucketedRisks[tenor];
          html += `<div style="padding:6px 10px;background:rgba(10,102,194,0.05);border-radius:8px">`;
          html += `<span style="color:var(--muted);font-size:0.85em">${tenor}:</span><br>`;
          html += `<strong style="color:var(--brand)">${Math.round(value).toLocaleString()}</strong>`;
          html += `</div>`;
        }
        html += '</div></div>';
      }

      // Display computation times for all engines
      if(Array.isArray(data) && data.length > 1){
        html += '<div class="field" style="margin-bottom:8px"><label>Computation Time</label>';
        html += '<div style="display:grid;gap:8px;margin-top:8px">';

        engines.forEach((engine) => {
          const name = engine.engineName || 'Unknown';
          html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:rgba(10,102,194,0.05);border-radius:8px">`;
          html += `<span style="font-size:0.9em;color:var(--muted)">${name}:</span>`;
          html += `<span class="pill">${(engine.latency_ms || 0).toFixed(2)} ms</span>`;
          html += `</div>`;
        });

        html += '</div></div>';
      } else {
        const engineLabel = baseline.engineName ? ` (${baseline.engineName})` : '';
        html += `<div class="field" style="margin-bottom:8px">
          <label>Computation Time${engineLabel}</label>
          <div class="pill">${(baseline.latency_ms || 0).toFixed(2)} ms</div>
        </div>`;
      }

      return html;
    }

    // Format XVA results
    function formatXVAResults(data){
      const baseline = Array.isArray(data) ? data[0] : data;
      const engines = Array.isArray(data) ? data : [data];

      // DEBUG: Log the baseline structure to see what fields are available
      if (CONFIG.ENABLE_DEBUG) {
        console.log('=== XVA Results Debug ===');
        console.log('Baseline object:', baseline);
        console.log('Available keys:', Object.keys(baseline));
        console.log('CVA (uppercase):', baseline.CVA);
        console.log('DVA (uppercase):', baseline.DVA);
        console.log('FVA (uppercase):', baseline.FVA);
        console.log('KVA (uppercase):', baseline.KVA);
        console.log('========================');
      }

      // API returns fields in uppercase: CVA, DVA, FVA, KVA
      const cva = baseline.CVA || baseline.cva || 0;
      const dva = baseline.DVA || baseline.dva || 0;
      const fva = baseline.FVA || baseline.fva || 0;
      const kva = baseline.KVA || baseline.kva || 0;

      let html = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
          <div class="field">
            <label>CVA</label>
            <div style="font-size:1.2em;font-weight:600;color:var(--brand)">${formatNotional(Math.round(cva))}</div>
          </div>
          <div class="field">
            <label>DVA</label>
            <div style="font-size:1.2em;font-weight:600;color:var(--ok)">${formatNotional(Math.round(dva))}</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
          <div class="field">
            <label>FVA</label>
            <div style="font-size:1.1em;font-weight:500">${formatNotional(Math.round(fva))}</div>
          </div>
          <div class="field">
            <label>KVA</label>
            <div style="font-size:1.1em;font-weight:500">${formatNotional(Math.round(kva))}</div>
          </div>
        </div>
      `;

      // Add exposure chart if EPE/ENE data is available
      if(baseline.EPE && baseline.ENE && baseline.grid_times){
        html += `
          <div class="field" style="margin-bottom:16px">
            <label>Exposure Profile (EPE / ENE)</label>
            <div style="margin-top:12px;background:#fff;padding:16px;border-radius:8px;border:1px solid var(--border)">
              <canvas id="xva-exposure-chart" style="height:300px;width:100%"></canvas>
            </div>
          </div>
        `;
      }

      // Add sensitivities section if available (from xva_risks endpoint)
      if(baseline.sensitivities){
        const sens = baseline.sensitivities;
        html += `
          <div class="field" style="margin-bottom:16px">
            <label>Risk Sensitivities (AAD)</label>
            <div style="margin-top:12px;background:#f8f9fa;padding:16px;border-radius:8px;border:1px solid var(--border)">
        `;

        // CVA Delta - Curve
        if(sens.cva_delta && sens.cva_delta.curve){
          html += `<div style="margin-bottom:16px">
            <div class="small mutetext" style="margin-bottom:8px">CVA Delta (Interest Rate Curve):</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">`;

          Object.entries(sens.cva_delta.curve).forEach(([tenor, value]) => {
            html += `<div style="display:flex;justify-content:space-between;padding:6px 10px;background:#fff;border-radius:6px">
              <span style="font-size:0.9em;font-weight:500">${tenor}:</span>
              <span style="font-size:0.9em;font-family:monospace">${formatNotional(Math.round(value))}</span>
            </div>`;
          });

          html += `</div></div>`;
        }

        // CVA Delta - Hazard Rates
        if(sens.cva_delta && (sens.cva_delta.hazard_cp || sens.cva_delta.hazard_own)){
          html += `<div style="margin-bottom:16px">
            <div class="small mutetext" style="margin-bottom:8px">CVA Delta (Hazard Rates):</div>`;

          if(sens.cva_delta.hazard_cp){
            html += `<div style="margin-bottom:8px">
              <div style="font-size:0.85em;color:var(--muted);margin-bottom:4px">Counterparty:</div>
              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">`;

            Object.entries(sens.cva_delta.hazard_cp).forEach(([tenor, value]) => {
              html += `<div style="display:flex;justify-content:space-between;padding:6px 10px;background:#fff;border-radius:6px">
                <span style="font-size:0.9em;font-weight:500">${tenor}:</span>
                <span style="font-size:0.9em;font-family:monospace">${formatNotional(Math.round(value))}</span>
              </div>`;
            });

            html += `</div></div>`;
          }

          if(sens.cva_delta.hazard_own){
            html += `<div>
              <div style="font-size:0.85em;color:var(--muted);margin-bottom:4px">Own:</div>
              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">`;

            Object.entries(sens.cva_delta.hazard_own).forEach(([tenor, value]) => {
              html += `<div style="display:flex;justify-content:space-between;padding:6px 10px;background:#fff;border-radius:6px">
                <span style="font-size:0.9em;font-weight:500">${tenor}:</span>
                <span style="font-size:0.9em;font-family:monospace">${formatNotional(Math.round(value))}</span>
              </div>`;
            });

            html += `</div></div>`;
          }

          html += `</div>`;
        }

        // CVA Vega
        if(sens.cva_vega !== undefined){
          html += `<div style="margin-bottom:16px">
            <div class="small mutetext" style="margin-bottom:8px">CVA Vega:</div>
            <div style="padding:8px 12px;background:#fff;border-radius:6px;display:inline-block">
              <span style="font-size:1em;font-weight:500;font-family:monospace">${formatNotional(Math.round(sens.cva_vega))}</span>
            </div>
          </div>`;
        }

        // Total Delta - Curve
        if(sens.total_delta && sens.total_delta.curve){
          html += `<div style="margin-bottom:8px">
            <div class="small mutetext" style="margin-bottom:8px">Total XVA Delta (Interest Rate Curve):</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">`;

          Object.entries(sens.total_delta.curve).forEach(([tenor, value]) => {
            html += `<div style="display:flex;justify-content:space-between;padding:6px 10px;background:#fff;border-radius:6px">
              <span style="font-size:0.9em;font-weight:500">${tenor}:</span>
              <span style="font-size:0.9em;font-family:monospace">${formatNotional(Math.round(value))}</span>
            </div>`;
          });

          html += `</div></div>`;
        }

        html += `</div></div>`;
      }

      // Display computation times for all engines
      if(Array.isArray(data) && data.length > 1){
        html += '<div class="field" style="margin-bottom:8px"><label>Computation Time</label>';
        html += '<div style="display:grid;gap:8px;margin-top:8px">';

        engines.forEach((engine) => {
          const name = engine.engineName || 'Unknown';
          html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:rgba(10,102,194,0.05);border-radius:8px">`;
          html += `<span style="font-size:0.9em;color:var(--muted)">${name}:</span>`;
          html += `<span class="pill">${(engine.latency_ms || 0).toFixed(2)} ms</span>`;
          html += `</div>`;
        });

        html += '</div></div>';
      } else {
        const engineLabel = baseline.engineName ? ` (${baseline.engineName})` : '';
        html += `<div class="field" style="margin-bottom:8px">
          <label>Computation Time${engineLabel}</label>
          <div class="pill">${(baseline.latency_ms || 0).toFixed(2)} ms</div>
        </div>`;
      }

      return html;
    }

    function sample(){
      clearAllErrors();

      // Helper: Random percentage rate (returns percentage value, not decimal)
      const randPctRate = () => (Math.random()*3 + 0.5).toFixed(1);
      const randMaturity = () => (Math.floor(Math.random()*8)+2).toFixed(1);

      // Populate shared fields (used for all calculation types)
      sharedFields.notional.value = formatNotional((Math.floor(Math.random()*9)+1) * 10_000_000);
      sharedFields.fixedRate.value = (Math.random()*2 + 1.5).toFixed(1);
      sharedFields.maturity.value = randMaturity();

      // Randomize curve (as percentage) - 6 tenors: 3M, 6M, 1Y, 2Y, 5Y, 10Y
      sharedFields.curve3m.value = randPctRate();
      sharedFields.curve6m.value = (parseFloat(sharedFields.curve3m.value) + 0.2).toFixed(1);
      sharedFields.curve1y.value = (parseFloat(sharedFields.curve6m.value) + 0.2).toFixed(1);
      sharedFields.curve2y.value = (parseFloat(sharedFields.curve1y.value) + 0.4).toFixed(1);
      sharedFields.curve5y.value = (parseFloat(sharedFields.curve2y.value) + 0.7).toFixed(1);
      sharedFields.curve10y.value = (parseFloat(sharedFields.curve5y.value) + 0.4).toFixed(1);

      // Populate XVA-specific fields if XVA tab is active
      if(activeTab === 'xva'){
        xvaFields.lgdCp.value = (Math.random()*30 + 50).toFixed(0);
        xvaFields.lgdOwn.value = (Math.random()*30 + 50).toFixed(0);
        xvaFields.funding.value = (Math.random()*30 + 10).toFixed(0);
        xvaFields.coc.value = (Math.random()*5 + 8).toFixed(0);
        xvaFields.capFactor.value = (Math.random()*20 + 40).toFixed(0);
        xvaFields.simVol.value = (Math.random()*30 + 40).toFixed(0);

        // Hazard curves as percentage
        xvaFields.hazCp1y.value = (Math.random()*0.5 + 0.8).toFixed(1);
        xvaFields.hazCp5y.value = (parseFloat(xvaFields.hazCp1y.value) + 0.2).toFixed(1);
        xvaFields.hazCp10y.value = (parseFloat(xvaFields.hazCp5y.value) + 0.3).toFixed(1);
        xvaFields.hazOwn1y.value = (Math.random()*0.4 + 0.6).toFixed(1);
        xvaFields.hazOwn5y.value = (parseFloat(xvaFields.hazOwn1y.value) + 0.2).toFixed(1);
        xvaFields.hazOwn10y.value = (parseFloat(xvaFields.hazOwn5y.value) + 0.2).toFixed(1);
      }

      saveFormState(); // Save to localStorage
    }

    async function run(){
      // Validate inputs before running
      if(!validateAllFields()){
        setStatus('err', 'Invalid inputs');
        return;
      }
      const base = API_BASE_URL;

      // Determine endpoint based on active tab
      let endpoint;
      let baseRequestBody = {};

      if(activeTab === 'pv'){
        endpoint = 'swap/price';
        baseRequestBody = {
          swap: buildSwapRequest(sharedFields, sharedPayFreq, sharedPayType, true)
        };
      } else if(activeTab === 'risk'){
        endpoint = 'swap/risks';
        baseRequestBody = {
          swap: buildSwapRequest(sharedFields, sharedPayFreq, sharedPayType, true)
        };
      } else if(activeTab === 'xva'){
        endpoint = 'swap/xva';
        const xvaSwap = buildSwapRequest(sharedFields, sharedPayFreq, sharedPayType, false);
        // Build XVA curve using buildCurve for consistency (same 6 tenors as PV/Risk)
        const xvaTenors = ['3M', '6M', '1Y', '2Y', '5Y', '10Y'];
        xvaSwap.curve = buildCurve(sharedFields, xvaTenors);

        baseRequestBody = {
          swap: xvaSwap,
          xva: {
            lgd_cp: pctToDecimal(xvaFields.lgdCp.value),
            lgd_own: pctToDecimal(xvaFields.lgdOwn.value),
            hazard_cp_curve: {
              '1Y': pctToDecimal(xvaFields.hazCp1y.value),
              '5Y': pctToDecimal(xvaFields.hazCp5y.value),
              '10Y': pctToDecimal(xvaFields.hazCp10y.value)
            },
            hazard_own_curve: {
              '1Y': pctToDecimal(xvaFields.hazOwn1y.value),
              '5Y': pctToDecimal(xvaFields.hazOwn5y.value),
              '10Y': pctToDecimal(xvaFields.hazOwn10y.value)
            },
            funding_spread: bpToDecimal(xvaFields.funding.value),
            cost_of_capital: pctToDecimal(xvaFields.coc.value),
            capital_factor: pctToDecimal(xvaFields.capFactor.value),
            grid_months: 3  // Fixed value for time grid spacing
          }
        };
      }

      setStatus('warn','running…');
      setLoading(true);

      try{
        const url = `${base}/${endpoint}`;

        // Send single request without engine config - API will run all engine configurations
        reqbox.textContent = JSON.stringify(baseRequestBody, null, 2);

        const res = await fetchWithTimeout(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(baseRequestBody)
        });

        const txt = await res.text();

        try{
          const raw = JSON.parse(txt);

          // DEBUG: Log raw API response structure
          if (CONFIG.ENABLE_DEBUG) {
            console.log('=== Raw API Response ===');
            console.log('Endpoint:', endpoint);
            console.log('Response keys:', Object.keys(raw));
            console.log('Full response:', raw);
            console.log('========================');
          }

          // Extract results from API response
          // API returns: {baseline: {result: {...}, time_sec: ...}, ...}
          const extractResult = (data) => {
            if (!data) return null;

            // Extract the nested result object and merge with timing info
            const result = data.result || data;
            if (data.time_sec !== undefined) {
              result.latency_ms = data.time_sec * 1000;
            }
            return result;
          };

          // Build results array with engine names
          // API now returns: baseline (JAX noJIT), JIT, AAD_JIT
          const engineMap = [
            { key: 'baseline', name: 'Baseline', data: raw.baseline },
            { key: 'JIT', name: 'JIT', data: raw.JIT },
            { key: 'AAD_JIT', name: 'AAD+JIT', data: raw.AAD_JIT }
          ];

          const results = engineMap
            .filter(e => e.data != null)
            .map(e => {
              const result = extractResult(e.data);
              result.engineName = e.name; // Add engine name to result
              return result;
            });

          out.textContent = JSON.stringify(raw, null, 2);
          out.parentElement.classList.add('fade-in');

          if(res.ok){
            // Display parsed comparison results as array
            displayParsedResults(results);
            setStatus('ok', 'success');
          } else {
            setStatus('err', `HTTP ${res.status} error`);
            displayParsedResults(null);
          }
        }
        catch{
          out.textContent = txt;
          setStatus('err', 'Parse error');
          displayParsedResults(null);
        }
      }catch(e){
        let errorMsg = 'Network request failed. ';
        if(e.message.includes('Failed to fetch')){
          errorMsg += 'Check your internet connection or API URL.';
        } else {
          errorMsg += e.message;
        }
        out.textContent = errorMsg;
        setStatus('err','Network error');
        displayParsedResults(null);
      } finally {
        setLoading(false);
      }
    }

    // Run XVA Monte Carlo calculation
    async function runXVAMC(){
      // Validate inputs before running
      if(!validateAllFields()){
        setStatus('err', 'Invalid inputs');
        return;
      }

      const base = API_BASE_URL;
      const endpoint = 'swap/xva_risks';

      // Build XVA swap request using shared fields
      const xvaSwap = buildSwapRequest(sharedFields, sharedPayFreq, sharedPayType, false);
      const xvaTenors = ['3M', '6M', '1Y', '2Y', '5Y', '10Y'];
      xvaSwap.curve = buildCurve(sharedFields, xvaTenors);

      const requestBody = {
        swap: xvaSwap,
        xva: {
          lgd_cp: pctToDecimal(xvaFields.lgdCp.value),
          lgd_own: pctToDecimal(xvaFields.lgdOwn.value),
          hazard_cp_curve: {
            '1Y': pctToDecimal(xvaFields.hazCp1y.value),
            '5Y': pctToDecimal(xvaFields.hazCp5y.value),
            '10Y': pctToDecimal(xvaFields.hazCp10y.value)
          },
          hazard_own_curve: {
            '1Y': pctToDecimal(xvaFields.hazOwn1y.value),
            '5Y': pctToDecimal(xvaFields.hazOwn5y.value),
            '10Y': pctToDecimal(xvaFields.hazOwn10y.value)
          },
          funding_spread: bpToDecimal(xvaFields.funding.value),
          cost_of_capital: pctToDecimal(xvaFields.coc.value),
          capital_factor: pctToDecimal(xvaFields.capFactor.value),
          grid_months: 3,  // Fixed value
          normal_vol: bpToDecimal(xvaFields.simVol.value),  // Simulation volatility from user input
          n_paths: 200  // Fixed number of Monte Carlo paths
        }
      };

      setStatus('warn','running MC…');
      setLoading(true);

      try{
        const url = `${base}/${endpoint}`;

        reqbox.textContent = JSON.stringify(requestBody, null, 2);

        const res = await fetchWithTimeout(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(requestBody)
        });

        const txt = await res.text();

        try{
          const raw = JSON.parse(txt);

          // DEBUG: Log raw API response structure
          if (CONFIG.ENABLE_DEBUG) {
            console.log('=== Raw XVA MC Response ===');
            console.log('Response keys:', Object.keys(raw));
            console.log('Full response:', raw);
            console.log('========================');
          }

          // XVA Risks endpoint returns a single result (not 3 engines)
          // Response structure: { input: {...}, result: {...}, time_sec: ... }
          const result = raw.result || {};
          if (raw.time_sec !== undefined) {
            result.latency_ms = raw.time_sec * 1000;
          }
          result.engineName = 'AAD+JIT'; // XVA Risks uses AAD+JIT

          out.textContent = JSON.stringify(raw, null, 2);
          out.parentElement.classList.add('fade-in');

          if(res.ok){
            // Display result as single-item array
            displayParsedResults([result]);
            setStatus('ok', 'MC success');
          } else {
            setStatus('err', `HTTP ${res.status} error`);
            displayParsedResults(null);
          }
        }
        catch{
          out.textContent = txt;
          setStatus('err', 'Parse error');
          displayParsedResults(null);
        }
      }catch(e){
        let errorMsg = 'Network request failed. ';
        if(e.message.includes('Failed to fetch')){
          errorMsg += 'Check your internet connection or API URL.';
        } else {
          errorMsg += e.message;
        }
        out.textContent = errorMsg;
        setStatus('err','Network error');
        displayParsedResults(null);
      } finally {
        setLoading(false);
      }
    }

    // Test API connection (silent, no popup)
    async function testConnection(){
      setStatus('warn', 'connecting…');

      try{
        const res = await fetchWithTimeout(`${API_BASE_URL}/`);
        const data = await res.json();

        if(res.ok && data.status === 'ok'){
          setStatus('ok', 'API ready');
        } else {
          setStatus('err', 'API error');
        }
      }catch(e){
        setStatus('err', 'API offline');
      }
    }

    // localStorage persistence functions
    function saveFormState(){
      try{
        const state = {
          // Shared fields
          notional: sharedFields.notional.value,
          fixedRate: sharedFields.fixedRate.value,
          maturity: sharedFields.maturity.value,
          curve3m: sharedFields.curve3m.value,
          curve6m: sharedFields.curve6m.value,
          curve1y: sharedFields.curve1y.value,
          curve2y: sharedFields.curve2y.value,
          curve5y: sharedFields.curve5y.value,
          curve10y: sharedFields.curve10y.value,
          payFreq: sharedPayFreq,
          payType: sharedPayType,
          // XVA-specific fields
          xva: {
            lgdCp: xvaFields.lgdCp.value,
            lgdOwn: xvaFields.lgdOwn.value,
            funding: xvaFields.funding.value,
            coc: xvaFields.coc.value,
            capFactor: xvaFields.capFactor.value,
            simVol: xvaFields.simVol.value,
            hazCp1y: xvaFields.hazCp1y.value,
            hazCp5y: xvaFields.hazCp5y.value,
            hazCp10y: xvaFields.hazCp10y.value,
            hazOwn1y: xvaFields.hazOwn1y.value,
            hazOwn5y: xvaFields.hazOwn5y.value,
            hazOwn10y: xvaFields.hazOwn10y.value
          },
          // Active tab
          activeTab: activeTab
        };
        localStorage.setItem('neutryx-core-form-state', JSON.stringify(state));
      }catch(e){
        console.warn('Failed to save form state:', e);
      }
    }

    function restoreFormState(){
      try{
        const saved = localStorage.getItem('neutryx-core-form-state');
        if(!saved) return;

        const state = JSON.parse(saved);

        // Restore shared fields
        if(state.notional) sharedFields.notional.value = state.notional;
        if(state.fixedRate) sharedFields.fixedRate.value = state.fixedRate;
        if(state.maturity) sharedFields.maturity.value = state.maturity;
        if(state.curve3m) sharedFields.curve3m.value = state.curve3m;
        if(state.curve6m) sharedFields.curve6m.value = state.curve6m;
        if(state.curve1y) sharedFields.curve1y.value = state.curve1y;
        if(state.curve2y) sharedFields.curve2y.value = state.curve2y;
        if(state.curve5y) sharedFields.curve5y.value = state.curve5y;
        if(state.curve10y) sharedFields.curve10y.value = state.curve10y;

        // Restore pay frequency and type
        if(state.payFreq){
          sharedPayFreq = state.payFreq;
          // Update toggle button active state
          const freqToggle = $('#shared-pay-freq-toggle');
          if(freqToggle){
            freqToggle.querySelectorAll('.freq-option').forEach(btn => {
              btn.classList.toggle('active', parseInt(btn.getAttribute('data-freq')) === state.payFreq);
            });
          }
        }
        if(state.payType){
          sharedPayType = state.payType;
          // Update type toggle button active state
          const typeToggle = $('#shared-type-toggle');
          if(typeToggle){
            typeToggle.querySelectorAll('.freq-option').forEach(btn => {
              btn.classList.toggle('active', btn.getAttribute('data-type') === state.payType);
            });
          }
        }

        // Restore XVA-specific fields
        if(state.xva){
          if(state.xva.lgdCp) xvaFields.lgdCp.value = state.xva.lgdCp;
          if(state.xva.lgdOwn) xvaFields.lgdOwn.value = state.xva.lgdOwn;
          if(state.xva.funding) xvaFields.funding.value = state.xva.funding;
          if(state.xva.coc) xvaFields.coc.value = state.xva.coc;
          if(state.xva.capFactor) xvaFields.capFactor.value = state.xva.capFactor;
          if(state.xva.simVol) xvaFields.simVol.value = state.xva.simVol;
          if(state.xva.hazCp1y) xvaFields.hazCp1y.value = state.xva.hazCp1y;
          if(state.xva.hazCp5y) xvaFields.hazCp5y.value = state.xva.hazCp5y;
          if(state.xva.hazCp10y) xvaFields.hazCp10y.value = state.xva.hazCp10y;
          if(state.xva.hazOwn1y) xvaFields.hazOwn1y.value = state.xva.hazOwn1y;
          if(state.xva.hazOwn5y) xvaFields.hazOwn5y.value = state.xva.hazOwn5y;
          if(state.xva.hazOwn10y) xvaFields.hazOwn10y.value = state.xva.hazOwn10y;
        }

        // Restore active tab
        if(state.activeTab){
          switchTab(state.activeTab);
        }
      }catch(e){
        console.warn('Failed to restore form state:', e);
      }
    }

    // Event listeners
    btnRun.addEventListener('click', run);
    btnSample.addEventListener('click', sample);

    const btnXVAMC = $('#btnXVAMC');
    if(btnXVAMC){
      btnXVAMC.addEventListener('click', runXVAMC);
    }

    // Add change event listeners to all input fields to auto-save
    $$('input').forEach(input => {
      input.addEventListener('change', saveFormState);
    });

    // Initialize: restore saved state, then switch to default tab
    restoreFormState();
    if(!localStorage.getItem('neutryx-core-form-state')){
      switchTab('pv'); // Only switch to default if no saved state
    }

    // Auto-test API connection on page load
    testConnection();

    // Initialize theme and animations
    initTheme();
    initScrollAnimations();

    // Theme toggle button
    const themeToggle = $('#theme-toggle');
    if(themeToggle){
      themeToggle.addEventListener('click', toggleTheme);
    }

    // Initialize Lucide icons
    if(typeof lucide !== 'undefined'){
      lucide.createIcons();
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Enter or Ctrl+Enter to run
      if((e.key === 'Enter' && e.ctrlKey) || (e.key === 'Enter' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT')){
        e.preventDefault();
        if(!btnRun.disabled) run();
      }
      // Escape to clear errors
      if(e.key === 'Escape'){
        clearAllErrors();
        setStatus('muted', 'idle');
      }
    });
  </script>
</body>
</html>
